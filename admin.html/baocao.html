<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartExpense ‚Äì Admin / B√°o c√°o</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ===== Design tokens ===== */
    :root{
      --bg:#ECF5FA; --panel:#FFFFFF; --text:#0F172A; --muted:#6B7280;
      --primary:#22C55E; --danger:#EF4444; --blue:#3B82F6;
      --border:#E2E8F0; --radius:14px; --shadow:0 8px 24px rgba(15,23,42,.06);
    }

    /* ===== Header UI Kit (ƒë·ªìng b·ªô) ===== */
    :root{
      --control-h:44px;
      --pill-radius:999px;
      --pill-grad:linear-gradient(180deg,#FFFFFF 0%,#F9FAFB 100%);
      --pill-shadow:inset 0 1px 0 #FFFFFF, 0 6px 16px rgba(15,23,42,.06);

      --title-size:22px;
      --title-weight:700;
      --title-tracking:.2px;
      --pill-font-size:15px;
    }
    header .page-title{
      margin:0;
      font-size:var(--title-size);
      font-weight:var(--title-weight);
      letter-spacing:var(--title-tracking);
      line-height:1.2;
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }
    header .search{position:relative; flex:1; max-width:720px}
    header .search input{
      width:100%; height:var(--control-h);
      border-radius:var(--pill-radius);
      border:1px solid var(--border);
      padding:0 14px 0 44px;
      background:var(--pill-grad);
      box-shadow:var(--pill-shadow);
      color:var(--text); outline:none;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      font-size:var(--pill-font-size);
      font-weight:600; line-height:1;
    }
    header .search input::placeholder{color:var(--muted); font-weight:500}
    header .search .icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);opacity:.6}
    header .btn, header .select{
      height:var(--control-h);
      border-radius:var(--pill-radius);
      border:1px solid var(--border);
      padding:0 14px;
      background:var(--pill-grad);
      box-shadow:var(--pill-shadow);
      cursor:pointer;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      font-size:var(--pill-font-size);
      font-weight:600; line-height:1; color:var(--text);
    }
    header .btn:hover, header .select:hover, header .search input:hover{ background:#F7FAFF; }
    header .btn[disabled]{opacity:.5;cursor:not-allowed}
    header .select{
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 8l4 4 4-4' stroke='%238A94A6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 12px center; padding-right:34px;
    }

    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}

    /* ===== Layout ===== */
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100dvh}
    aside{background:var(--panel);border-right:1px solid var(--border);padding:18px;position:sticky;top:0;height:100dvh}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px}
    .logo-badge{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#FFE9DE 0%,#FFF5EE 100%);box-shadow:0 6px 16px rgba(15,23,42,.08), inset 0 0 0 1px rgba(255,255,255,.6);display:block;overflow:hidden}
    .brand-logo{width:100%;height:100%;object-fit:contain}
    .nav{margin-top:16px;display:flex;flex-direction:column;gap:6px}
    .nav a{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);padding:10px 12px;border-radius:12px;transition:background .25s,transform .15s}
    .nav a .ic{width:22px}
    .nav a:hover{background:#F3F4F6;transform:translateX(2px)}
    .nav a.active{background:#A7EFC1;color:#065F46;font-weight:600}

    main{display:flex;flex-direction:column;min-width:0}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:12px 16px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    .toolbar{display:flex;align-items:center;gap:12px;flex:1;justify-content:center}
    .btn{all:unset;cursor:pointer;background:#F3F4F6;border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-weight:600}
    .btn:hover{background:#EDF2F7}

    .content{padding:20px;display:grid;gap:16px}
    .card{background:var(--panel);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border)}

    /* ===== KPI ===== */
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:16px}
    .kpi{height:120px;display:flex;flex-direction:column;justify-content:space-between}
    .kpi .title{font-size:13px;color:var(--muted)}
    .kpi .value{font-size:28px;font-weight:700;line-height:1.1;font-variant-numeric:tabular-nums}
    .kpi .trend{font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;height:28px;padding:0 10px;border-radius:999px;font-size:12px;font-weight:700}
    .b-blue{background:#E0EDFF;color:#1D4ED8}
    .b-green{background:#DCFCE7;color:#065F46}
    .b-red{background:#FEE2E2;color:#991B1B}
    .b-yellow{background:#FEF9C3;color:#854D0E}

    /* ===== Grid + charts ===== */
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .chart{height:340px;border-radius:12px;background:linear-gradient(180deg,#FFFFFF 0%,#FBFBFD 100%);border:1px solid var(--border)}

    /* ===== Table ===== */
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:8px 10px}
    td{background:#fff;padding:12px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);vertical-align:middle}
    tr td:first-child{border-left:1px solid var(--border);border-radius:10px 0 0 10px}
    tr td:last-child{border-right:1px solid var(--border);border-radius:0 10px 10px 0}
    .num{font-variant-numeric:tabular-nums}
    .muted{color:var(--muted)}
    .status{display:inline-flex;align-items:center;height:26px;padding:0 10px;border-radius:999px;font-size:12px;font-weight:700}
    .s-ok{background:#DCFCE7;color:#065F46}
    .s-flag{background:#FEE2E2;color:#991B1B}
    .s-review{background:#FEF9C3;color:#854D0E}

    /* ===== Chips ===== */
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{height:30px;padding:0 10px;border-radius:999px;background:#F3F4F6;border:1px solid var(--border);display:inline-flex;align-items:center;font-size:12px;cursor:pointer}
    .chip.active{background:#DCFCE7;color:#065F46;border-color:#86EFAC}

    /* ===== Responsive ===== */
    @media (max-width:1200px){.kpis{grid-template-columns:repeat(2,1fr)}.grid{grid-template-columns:1fr}}
    @media (max-width:780px){
      .app{grid-template-columns:1fr}
      aside{position:fixed;inset:0 40% 0 0;transform:translateX(-100%);transition:.2s;z-index:100}
      aside.show{transform:none}
      /* kh√¥ng c√≤n n√∫t menu */
    }
  </style>

  <link rel="icon" href="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w96-h96-rw" sizes="96x96">
  <link rel="apple-touch-icon" href="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w180-h180-rw">
</head>
<body>
  <div class="app">
    <!-- ===== SIDEBAR ===== -->
    <aside id="sidebar">
      <div class="brand">
        <span class="logo-badge">
          <img class="brand-logo" src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt="SmartExpense Admin Logo" loading="lazy">
        </span>
        SmartExpense Admin
      </div>
      <nav class="nav">
        <a href="tongquan.html"><span class="ic">üè†</span> T·ªïng quan</a>
        <a href="nguoidung.html"><span class="ic">üë•</span> Ng∆∞·ªùi d√πng</a>
        <a href="giaodich.html"><span class="ic">üí≥</span> Giao d·ªãch</a>
        <a href="ai_insights.html"><span class="ic">ü§ñ</span> AI Insights</a>
        <a class="active" href="#"><span class="ic">üìä</span> B√°o c√°o</a>
        <a href="#"><span class="ic">‚öôÔ∏è</span> C√†i ƒë·∫∑t</a>
        <a href="#"><span class="ic">üö™</span> ƒêƒÉng xu·∫•t</a>
      </nav>
    </aside>

    <!-- ===== MAIN ===== -->
    <main>
      <header>
        <!-- ƒê√É XO√Å N√öT 3 G·∫†CH -->
        <h2 class="page-title">B√°o c√°o</h2>

        <div class="toolbar">
          <select class="select" id="fRange" title="Kho·∫£ng th·ªùi gian">
            <option value="30">30 ng√†y</option>
            <option value="90">90 ng√†y</option>
            <option value="365" selected>365 ng√†y</option>
          </select>
          <select class="select" id="fGroup" title="Nh√≥m theo">
            <option value="month" selected>Th√°ng</option>
            <option value="week">Tu·∫ßn</option>
            <option value="day">Ng√†y</option>
          </select>
          <select class="select" id="fMetric" title="Ch·ªâ s·ªë">
            <option value="revenue" selected>Doanh thu</option>
            <option value="tx">Giao d·ªãch</option>
            <option value="users">Ng∆∞·ªùi d√πng m·ªõi</option>
          </select>

          <button class="btn" id="btnExport">Xu·∫•t CSV</button>
          <button class="btn" id="btnPng">T·∫£i ·∫£nh bi·ªÉu ƒë·ªì</button>
          <button class="btn" id="btnPrint">üñ® In</button>
        </div>

        <div class="avatar" aria-label="T√†i kho·∫£n" style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;background:#FDE68A"></div>
          <div style="font-weight:600">Admin</div>
        </div>
      </header>

      <div class="content">
        <div class="card" style="padding:10px 12px">
          <div class="chips">
            <span class="chip" data-quick="this-month">üìÖ Th√°ng n√†y</span>
            <span class="chip" data-quick="this-quarter">üìà Qu√Ω n√†y</span>
            <span class="chip" data-quick="ytd">üóì NƒÉm nay (YTD)</span>
            <span class="chip" data-quick="last-12">üïõ 12 th√°ng qua</span>
          </div>
        </div>

        <!-- KPI -->
        <section class="kpis">
          <div class="card kpi">
            <div class="title">T·ªïng doanh thu</div>
            <div class="value num" id="k_rev">‚Äî</div>
            <div class="trend"><span class="badge b-green" id="k_rev_trend">‚Äî</span></div>
          </div>
          <div class="card kpi">
            <div class="title">T·ªïng giao d·ªãch</div>
            <div class="value num" id="k_tx">‚Äî</div>
            <div class="trend"><span class="badge b-blue" id="k_tx_trend">‚Äî</span></div>
          </div>
          <div class="card kpi">
            <div class="title">Ng∆∞·ªùi d√πng m·ªõi</div>
            <div class="value num" id="k_users">‚Äî</div>
            <div class="trend"><span class="badge b-yellow" id="k_users_trend">‚Äî</span></div>
          </div>
          <div class="card kpi">
            <div class="title">T·ªâ l·ªá flagged</div>
            <div class="value num" id="k_flag">‚Äî</div>
            <div class="trend"><span class="badge b-red" id="k_flag_trend">‚Äî</span></div>
          </div>
        </section>

        <!-- CHART + RIGHT -->
        <section class="grid">
          <div class="card">
            <h3 id="chartTitle" style="margin:0 0 12px 0">Xu h∆∞·ªõng theo th√°ng</h3>
            <canvas id="mainChart" class="chart"></canvas>
          </div>

          <div class="card">
            <h3 style="margin:0 0 12px 0">Ph√¢n b·ªë theo danh m·ª•c</h3>
            <canvas id="pieChart" class="chart" style="height:340px"></canvas>
          </div>
        </section>

        <!-- B·∫£ng t·ªïng h·ª£p -->
        <section class="card">
          <h3 style="margin:0 0 12px 0">B·∫£ng t·ªïng h·ª£p</h3>
          <table>
            <thead>
              <tr>
                <th>K·ª≥</th>
                <th>Doanh thu</th>
                <th>Giao d·ªãch</th>
                <th>Ng∆∞·ªùi d√πng m·ªõi</th>
                <th>Flagged (%)</th>
              </tr>
            </thead>
            <tbody id="tblReport"></tbody>
          </table>
        </section>
      </div>
    </main>
  </div>

  <script>
    /* ======= Demo Data Generator (365 ng√†y) ======= */
    const VND = n => n.toLocaleString('vi-VN') + ' ‚Ç´';
    const PCT = x => (x*100).toFixed(1) + '%';

    function genDaily(nDays=365){
      const out=[];
      const now = new Date();
      for(let i=nDays-1;i>=0;i--){
        const d = new Date(now); d.setDate(now.getDate()-i);
        const month = d.getMonth();
        const season = [1.05,1.02,1.0,0.98,0.96,0.95,0.97,1.0,1.03,1.06,1.1,1.15][month];
        const baseRev = 900000 + Math.random()*200000;
        const revenue = Math.round(baseRev * season * (0.9 + Math.random()*0.3));
        const tx = Math.round(80 * season * (0.9 + Math.random()*0.4));
        const users = Math.max(2, Math.round(8 * (0.8 + Math.random()*0.6)));
        const flaggedRate = Math.min(0.2, Math.max(0.01, 0.05 + (Math.random()-0.5)*0.02));
        out.push({date: d.toISOString().slice(0,10), revenue, tx, users, flaggedRate});
      }
      return out;
    }
    const DAILY = genDaily(365);

    function groupData(rangeDays, groupBy){
      const end = new Date(); const start = new Date(); start.setDate(end.getDate()-rangeDays+1);
      const rows = DAILY.filter(r => new Date(r.date) >= start && new Date(r.date) <= end);
      const map = new Map();
      for(const r of rows){
        let key = r.date;
        if(groupBy==='week'){
          const t = new Date(r.date);
          const dayNum = (t.getUTCDay()+6)%7; t.setUTCDate(t.getUTCDate()-dayNum+3);
          const isoYear = t.getUTCFullYear();
          const jan4 = new Date(Date.UTC(isoYear,0,4));
          const week = 1 + Math.round(((t - jan4)/86400000 - 3 + ((jan4.getUTCDay()+6)%7))/7);
          key = `${isoYear}-W${String(week).padStart(2,'0')}`;
        }
        if(groupBy==='month'){ key = r.date.slice(0,7); }
        if(!map.has(key)) map.set(key,{key, revenue:0, tx:0, users:0, flaggedCnt:0, days:0});
        const it = map.get(key);
        it.revenue += r.revenue; it.tx += r.tx; it.users += r.users;
        it.flaggedCnt += Math.round(r.tx * r.flaggedRate); it.days++;
      }
      const list = Array.from(map.values()).sort((a,b)=> a.key.localeCompare(b.key));
      list.forEach(it=>{ it.flaggedRate = it.tx ? it.flaggedCnt/it.tx : 0; });
      return list;
    }

    const $ = id => document.getElementById(id);
    const state = { range:365, group:'month', metric:'revenue' };

    $('fRange').addEventListener('change', e=>{ state.range=+e.target.value; renderAll(); });
    $('fGroup').addEventListener('change', e=>{ state.group=e.target.value; renderAll(); });
    $('fMetric').addEventListener('change', e=>{ state.metric=e.target.value; renderAll(); });

    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        ch.classList.add('active');
        const q = ch.dataset.quick;
        if(q==='this-month'){ $('fRange').value='30'; $('fGroup').value='day'; state.range=30; state.group='day'; }
        if(q==='this-quarter'){ $('fRange').value='90'; $('fGroup').value='week'; state.range=90; state.group='week'; }
        if(q==='ytd' || q==='last-12'){ $('fRange').value='365'; $('fGroup').value='month'; state.range=365; state.group='month'; }
        renderAll();
      });
    });

    $('btnPrint').addEventListener('click', ()=> window.print());

    function renderKPI(list){
      const sum = list.reduce((s,x)=>({revenue:s.revenue+x.revenue, tx:s.tx+x.tx, users:s.users+x.users, flaggedCnt:s.flaggedCnt+x.flaggedCnt}), {revenue:0,tx:0,users:0,flaggedCnt:0});
      const prev = list.slice(0,-1);
      const sumPrev = prev.reduce((s,x)=>({revenue:s.revenue+x.revenue, tx:s.tx+x.tx, users:s.users+x.users, flaggedCnt:s.flaggedCnt+x.flaggedCnt}), {revenue:0,tx:0,users:0,flaggedCnt:0});
      const trend = (a,b)=> b? ((a-b)/b*100).toFixed(1)+'%':'‚Äî';
      $('k_rev').textContent = VND(sum.revenue);
      $('k_tx').textContent = sum.tx.toLocaleString('vi-VN');
      $('k_users').textContent = sum.users.toLocaleString('vi-VN');
      const flaggedRate = sum.tx? (sum.flaggedCnt/sum.tx) : 0;
      $('k_flag').textContent = (flaggedRate*100).toFixed(1)+'%';
      $('k_rev_trend').textContent = '‚ñ≤ ' + trend(sum.revenue, sumPrev.revenue);
      $('k_tx_trend').textContent = '‚ñ≤ ' + trend(sum.tx, sumPrev.tx);
      $('k_users_trend').textContent = '‚ñ≤ ' + trend(sum.users, sumPrev.users);
      $('k_flag_trend').textContent = '‚âà so v·ªõi k·ª≥ tr∆∞·ªõc';
    }

    function renderTable(list){
      $('tblReport').innerHTML = list.map(it=>`
        <tr>
          <td class="mono">${it.key}</td>
          <td class="num"><strong>${VND(it.revenue)}</strong></td>
          <td class="num">${it.tx.toLocaleString('vi-VN')}</td>
          <td class="num">${it.users.toLocaleString('vi-VN')}</td>
          <td class="num">${(it.flaggedRate*100).toFixed(1)}%</td>
        </tr>
      `).join('');
    }

    function sizeCanvas(canvas){
      const dpr = window.devicePixelRatio || 1;
      const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
      canvas.width = Math.round(cssW*dpr); canvas.height = Math.round(cssH*dpr);
      const ctx = canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
      return {ctx,W:cssW,H:cssH};
    }

    function drawMainChart(list, metric){
      const canvas = $('mainChart'); const {ctx,W,H} = sizeCanvas(canvas);
      ctx.clearRect(0,0,W,H);
      const pad = 36;
      const vals = list.map(x => metric==='revenue'? x.revenue : metric==='tx'? x.tx : x.users);
      const max = Math.max(...vals)*1.15 || 1;
      ctx.strokeStyle='#E5E7EB'; ctx.lineWidth=1;
      for(let i=0;i<4;i++){ const y = pad + i*(H-pad*2)/3; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke(); }
      const step = (W-pad*2)/Math.max(1,(list.length-1));
      const pts = list.map((it,i)=>[pad + i*step, H-pad - (vals[i]/max)*(H-pad*2)]);
      const grad = ctx.createLinearGradient(0,pad,0,H-pad);
      grad.addColorStop(0,'rgba(34,197,94,.25)'); grad.addColorStop(1,'rgba(34,197,94,0)');
      ctx.beginPath(); ctx.moveTo(pts[0][0],H-pad); pts.forEach(([x,y])=>ctx.lineTo(x,y)); ctx.lineTo(pts.at(-1)[0],H-pad); ctx.closePath();
      ctx.fillStyle = grad; ctx.fill();
      ctx.beginPath(); pts.forEach(([x,y],i)=> i?ctx.lineTo(x,y):ctx.moveTo(x,y));
      ctx.strokeStyle = '#22C55E'; ctx.lineWidth = 3; ctx.stroke();
      ctx.fillStyle='#22C55E';
      pts.forEach(([x,y],i)=>{ if(i%Math.ceil(list.length/12)===0 || i===list.length-1){ ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); }});
      $('chartTitle').textContent = `Xu h∆∞·ªõng ${metric==='revenue'?'doanh thu':metric==='tx'?'giao d·ªãch':'ng∆∞·ªùi d√πng m·ªõi'} (${list[0]?.key} ‚Üí ${list.at(-1)?.key})`;
    }

    function drawPie(categories){
      const canvas = $('pieChart'); const {ctx,W,H} = sizeCanvas(canvas);
      ctx.clearRect(0,0,W,H);
      const cx=W/2, cy=H/2, r=Math.min(W,H)*0.33;
      const total = categories.reduce((s,c)=>s+c.value,0) || 1;
      let start= -Math.PI/2;
      const colors = ['#22C55E','#3B82F6','#F59E0B','#EF4444','#8B5CF6','#10B981','#F472B6','#94A3B8'];
      categories.forEach((c,idx)=>{
        const angle = (c.value/total) * Math.PI*2;
        const end = start + angle;
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath();
        ctx.fillStyle = colors[idx%colors.length]; ctx.fill();
        start = end;
      });
      const x0 = 20, y0 = 20;
      ctx.font='12px Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.textBaseline='middle';
      categories.forEach((c,i)=>{
        const y = y0 + i*22;
        ctx.fillStyle=colors[i%colors.length]; ctx.fillRect(x0,y-6,12,12);
        ctx.fillStyle='#0F172A';
        const pct = ((c.value/Math.max(1,total))*100).toFixed(1)+'%';
        ctx.fillText(`${c.name} ‚Äî ${pct}`, x0+18, y);
      });
    }

    document.getElementById('btnExport').addEventListener('click', ()=>{
      const list = groupData(state.range, state.group);
      const rows = [['period','revenue','transactions','new_users','flagged_rate']];
      list.forEach(it=> rows.push([it.key, it.revenue, it.tx, it.users, it.flaggedRate]));
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download = `report_${state.group}_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(a.href);
    });

    document.getElementById('btnPng').addEventListener('click', ()=>{
      const a = document.createElement('a');
      a.href = document.getElementById('mainChart').toDataURL('image/png');
      a.download = `chart_${state.metric}_${Date.now()}.png`;
      a.click();
    });

    function buildCategories(rangeDays){
      const now = new Date();
      const curMonth = now.getMonth();
      const base = [
        {name:'Nh√† ·ªü', value: 34},
        {name:'ƒÇn u·ªëng', value: 22},
        {name:'Di chuy·ªÉn', value: 16},
        {name:'Gi·∫£i tr√≠', value: 10},
        {name:'Mua s·∫Øm', value: 9},
        {name:'Kh√°c', value: 9},
      ];
      if([0,11].includes(curMonth)) base[1].value+=3;
      if([5,6].includes(curMonth)) base[3].value+=2;
      const grp = groupData(rangeDays,'month');
      const totalRev = grp.reduce((s,x)=>s+x.revenue,0) || 1;
      const scale = totalRev / base.reduce((s,x)=>s+x.value,0);
      return base.map(b=>({name:b.name, value: Math.round(b.value*scale)}));
    }

    function renderAll(){
      const list = groupData(state.range, state.group);
      renderKPI(list);
      renderTable(list);
      drawMainChart(list, state.metric);
      drawPie(buildCategories(state.range));
    }

    renderAll();
    window.addEventListener('resize', renderAll);
  </script>
</body>
</html>
