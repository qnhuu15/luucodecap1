<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartExpense ‚Äì Admin / Giao d·ªãch</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ===== Design tokens ===== */
    :root{
      --bg:#ECF5FA; --panel:#FFFFFF; --text:#0F172A; --muted:#6B7280;
      --primary:#22C55E; --danger:#EF4444; --blue:#3B82F6;
      --border:#E2E8F0; --radius:14px; --shadow:0 8px 24px rgba(15,23,42,.06);
    }

    /* ===== Header UI Kit (ƒë·ªìng b·ªô) ===== */
    :root{
      --control-h:44px;
      --pill-radius:999px;
      --pill-grad:linear-gradient(180deg,#FFFFFF 0%,#F9FAFB 100%);
      --pill-shadow:inset 0 1px 0 #FFFFFF, 0 6px 16px rgba(15,23,42,.06);

      /* Typography header + khung tr·∫Øng */
      --title-size:24px;
      --title-weight:800;
      --title-tracking:.2px;
      --pill-font-size:15px;
    }
    /* Ti√™u ƒë·ªÅ header */
    header .page-title{
      margin:0;
      font: var(--title-weight) var(--title-size)/1.1 Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      letter-spacing:var(--title-tracking);
      color:var(--text);
    }
    /* Khung tr·∫Øng: Search + Button + Select */
    header .search{position:relative; flex:1; max-width:720px}
    header .search input{
      width:100%; height:var(--control-h);
      border-radius:var(--pill-radius);
      border:1px solid var(--border);
      padding:0 14px 0 44px;
      background:var(--pill-grad);
      box-shadow:var(--pill-shadow);
      color:var(--text); outline:none;

      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      font-size:var(--pill-font-size);
      font-weight:600; line-height:1;
    }
    header .search input::placeholder{color:var(--muted); font-weight:500}
    header .search .icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);opacity:.6}
    header .btn, header .select{
      height:var(--control-h);
      border-radius:var(--pill-radius);
      border:1px solid var(--border);
      padding:0 14px;
      background:var(--pill-grad);
      box-shadow:var(--pill-shadow);
      cursor:pointer;

      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      font-size:var(--pill-font-size);
      font-weight:600; line-height:1; color:var(--text);
    }
    header .btn:hover, header .select:hover, header .search input:hover{ background:#F7FAFF; }
    header .btn[disabled]{opacity:.5;cursor:not-allowed}
    header .select{
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 8l4 4 4-4' stroke='%238A94A6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 12px center; padding-right:34px;
    }

    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}

    /* ===== Layout ===== */
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100dvh}
    aside{background:var(--panel);border-right:1px solid var(--border);padding:18px;position:sticky;top:0;height:100dvh}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px}
    .logo-badge{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#FFE9DE 0%,#FFF5EE 100%);box-shadow:0 6px 16px rgba(15,23,42,.08), inset 0 0 0 1px rgba(255,255,255,.6);display:block;overflow:hidden}
    .brand-logo{width:100%;height:100%;object-fit:contain}
    .nav{margin-top:16px;display:flex;flex-direction:column;gap:6px}
    .nav a{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);padding:10px 12px;border-radius:12px;transition:background .25s,transform .15s}
    .nav a .ic{width:22px}
    .nav a:hover{background:#F3F4F6;transform:translateX(2px)}
    .nav a.active{background:#A7EFC1;color:#065F46;font-weight:600}

    main{display:flex;flex-direction:column;min-width:0}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:12px 16px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    .toolbar{display:flex;align-items:center;gap:12px;flex:1;justify-content:center}
    .menu-btn{display:none}
    .search{position:relative;flex:1;max-width:720px}
    .btn{all:unset;cursor:pointer;background:#F3F4F6;border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-weight:600}
    .btn:hover{background:#EDF2F7}

    .content{padding:20px;display:grid;gap:16px}
    .card{background:var(--panel);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border)}

    /* Chips + bulkbar */
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{height:30px;padding:0 10px;border-radius:999px;background:#F3F4F6;border:1px solid var(--border);display:inline-flex;align-items:center;font-size:12px;cursor:pointer}
    .chip.active{background:#DCFCE7;color:#065F46;border-color:#86EFAC}
    .bulkbar{display:none;align-items:center;justify-content:space-between;gap:10px;background:#F8FAFC;border:1px dashed var(--border);padding:10px 12px;border-radius:12px}
    .bulkbar.show{display:flex}
    .small{font-size:12px;color:var(--muted)}

    /* B·∫£ng */
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:8px 10px}
    td{background:#fff;padding:12px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);vertical-align:middle}
    tr td:first-child{border-left:1px solid var(--border);border-radius:10px 0 0 10px}
    tr td:last-child{border-right:1px solid var(--border);border-radius:0 10px 10px 0}
    .num{font-variant-numeric:tabular-nums}
    .amount.pos{color:#065F46;font-weight:700}
    .amount.neg{color:#991B1B;font-weight:700}
    .status{display:inline-flex;align-items:center;height:26px;padding:0 10px;border-radius:999px;font-size:12px;font-weight:700}
    .s-ok{background:#DCFCE7;color:#065F46}
    .s-flag{background:#FEE2E2;color:#991B1B}
    .s-review{background:#FEF9C3;color:#854D0E}
    .s-fail{background:#FEE2E2;color:#B91C1C}
    .link{color:#2563EB;text-decoration:none;font-weight:600}
    .link:hover{text-decoration:underline}
    .pag{display:flex;gap:8px;align-items:center}
    .pag .btn{padding:6px 10px}

    /* Drawer + overlay */
    .drawer{position:fixed;top:0;right:-480px;width:480px;height:100dvh;background:#fff;border-left:1px solid var(--border);box-shadow:-8px 0 24px rgba(15,23,42,.08);transition:right .25s;z-index:50;display:flex;flex-direction:column}
    .drawer.show{right:0}
    .drawer header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:14px 16px}
    .overlay{position:fixed;inset:0;background:rgba(15,23,42,.35);opacity:0;pointer-events:none;transition:opacity .2s;z-index:49}
    .overlay.show{opacity:1;pointer-events:auto}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:10px}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}

    @media (max-width:1000px){
      .app{grid-template-columns:1fr}
      aside{position:fixed;inset:0 40% 0 0;transform:translateX(-100%)}
      th:nth-child(5),td:nth-child(5),
      th:nth-child(7),td:nth-child(7){display:none} /* ·∫©n b·ªõt c·ªôt tr√™n m√†n nh·ªè */
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside>
      <div class="brand">
        <span class="logo-badge">
          <img class="brand-logo" src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt="SmartExpense" />
        </span>
        SmartExpense Admin
      </div>
      <nav class="nav" style="margin-top:14px">
        <a href="tongquan.html"><span class="ic">üè†</span> T·ªïng quan</a>
        <a href="nguoidung.html"><span class="ic">üë•</span> Ng∆∞·ªùi d√πng</a>
        <a class="active" href="giaodich.html"><span class="ic">üí≥</span> Giao d·ªãch</a>
        <a href="AI_Insights.html"><span class="ic">ü§ñ</span> AI Insights</a>
        <a href="baocao.html"><span class="ic">üìä</span> B√°o c√°o</a>
        <a href="#"><span class="ic">‚öôÔ∏è</span> C√†i ƒë·∫∑t</a>
        <a href="#"><span class="ic">üö™</span> ƒêƒÉng xu·∫•t</a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main>
      <header>
        <h2 class="page-title">Giao d·ªãch</h2>
        <div class="toolbar">
          <div class="search">
            <span class="icon">üîé</span>
            <input id="q" placeholder="T√¨m ID, ng∆∞·ªùi d√πng, ghi ch√∫..." aria-label="T√¨m ki·∫øm giao d·ªãch" />
          </div>

          <select id="fRange" class="select" title="Kho·∫£ng th·ªùi gian">
            <option value="7">7 ng√†y</option>
            <option value="30" selected>30 ng√†y</option>
            <option value="90">90 ng√†y</option>
          </select>
          <select id="fStatus" class="select" title="Tr·∫°ng th√°i">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="Success">Success</option>
            <option value="Review">Review</option>
            <option value="Flagged">Flagged</option>
            <option value="Failed">Failed</option>
          </select>
          <select id="fType" class="select" title="Lo·∫°i">
            <option value="">T·∫•t c·∫£ lo·∫°i</option>
            <option value="Expense">Expense</option>
            <option value="Income">Income</option>
          </select>
          <select id="fMethod" class="select" title="Ph∆∞∆°ng th·ª©c">
            <option value="">T·∫•t c·∫£ ph∆∞∆°ng th·ª©c</option>
            <option value="Vietcombank">Vietcombank</option>
            <option value="Momo">Momo</option>
            <option value="ZaloPay">ZaloPay</option>
            <option value="Cash">Cash</option>
          </select>

          <button class="btn" id="btnClear">X√≥a l·ªçc</button>
        </div>
      </header>

      <div class="content">
        <!-- Quick chips -->
        <div class="card" style="padding:12px">
          <div class="chips">
            <span class="chip" data-quick="big">üí∞ > 5.000.000 ‚Ç´</span>
            <span class="chip" data-quick="flag">‚ö†Ô∏è Flagged/Review</span>
            <span class="chip" data-quick="fail">‚ùå Failed</span>
            <span class="chip" data-quick="cash">üíµ Cash</span>
          </div>
        </div>

        <!-- Bulk bar -->
        <div id="bulkbar" class="bulkbar" aria-live="polite">
          <div><strong id="selCount">0</strong> m·ª•c ƒë√£ ch·ªçn</div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="bulkMark">ƒê√°nh d·∫•u ƒë√£ xem</button>
            <button class="btn" id="bulkExport">Xu·∫•t CSV</button>
          </div>
        </div>

        <!-- Table -->
        <div class="card">
          <table>
            <thead>
              <tr>
                <th style="width:36px"><input type="checkbox" id="chkAll" aria-label="Ch·ªçn t·∫•t c·∫£"></th>
                <th>ID</th>
                <th>Ng∆∞·ªùi d√πng</th>
                <th>Lo·∫°i</th>
                <th>Danh m·ª•c</th>
                <th>Ph∆∞∆°ng th·ª©c</th>
                <th class="num">S·ªë ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Th·ªùi gian</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div class="small" id="resultInfo">‚Äî</div>
            <div class="pag">
              <button class="btn" id="prev">‚óÄ</button>
              <span class="small" id="pageInfo">1/1</span>
              <button class="btn" id="next">‚ñ∂</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Overlay + Drawer -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>
  <div id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-modal="true">
    <header>
      <strong id="d_title">Chi ti·∫øt giao d·ªãch</strong>
      <button class="btn" id="d_close">‚úï</button>
    </header>
    <div style="padding:16px;display:grid;gap:16px;overflow:auto">
      <div class="kv">
        <div class="muted">M√£ giao d·ªãch</div><div id="d_id" class="mono"></div>
        <div class="muted">Ng∆∞·ªùi d√πng</div><div id="d_user"></div>
        <div class="muted">Lo·∫°i</div><div id="d_type"></div>
        <div class="muted">Danh m·ª•c</div><div id="d_cat"></div>
        <div class="muted">Ph∆∞∆°ng th·ª©c</div><div id="d_method"></div>
        <div class="muted">S·ªë ti·ªÅn</div><div id="d_amount" class="num"></div>
        <div class="muted">Tr·∫°ng th√°i</div><div id="d_status"></div>
        <div class="muted">Th·ªùi gian</div><div id="d_time"></div>
        <div class="muted">Ghi ch√∫</div><div id="d_note" class="muted">‚Äî</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="d_mark">ƒê√°nh d·∫•u ƒë√£ xem</button>
        <button class="btn" id="d_refund">Ho√†n ti·ªÅn</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== Demo data ===== */
    const TXS = [
      {id:"#TX2391", user:"Linh Nguy·ªÖn", uid:"U002", type:"Expense", category:"ƒÇn u·ªëng",  method:"Momo",       amount:-230000, status:"Success", time:"2025-11-08T18:25:00", note:"B·ªØa tr∆∞a"},
      {id:"#TX2390", user:"Thanh L√™",    uid:"U003", type:"Income",  category:"L∆∞∆°ng",    method:"Vietcombank",amount: 4500000, status:"Success", time:"2025-11-08T18:10:00", note:"L∆∞∆°ng th√°ng 11"},
      {id:"#TX2389", user:"Minh V√µ",     uid:"U001", type:"Expense", category:"Gi·∫£i tr√≠", method:"ZaloPay",    amount: -89000, status:"Review",  time:"2025-11-08T18:06:00", note:"Phim"},
      {id:"#TX2388", user:"H√≤a Ph·∫°m",    uid:"U004", type:"Expense", category:"Nh√† ·ªü",    method:"Vietcombank",amount:-1200000, status:"Flagged", time:"2025-11-08T17:50:00", note:"Ti·ªÅn ƒëi·ªán"},
      {id:"#TX2387", user:"Admin Root",  uid:"U005", type:"Income",  category:"Ho√†n ti·ªÅn",method:"Cash",       amount: 3000000, status:"Success", time:"2025-11-07T20:10:00", note:"Refund"},
      {id:"#TX2386", user:"Qu√¢n ƒê·ªó",     uid:"U007", type:"Expense", category:"Di chuy·ªÉn",method:"Momo",       amount: -62000, status:"Success", time:"2025-11-07T09:30:00", note:"Grab"},
      {id:"#TX2385", user:"My L√™",       uid:"U008", type:"Expense", category:"ƒÇn u·ªëng",  method:"Cash",       amount:-5200000, status:"Failed",  time:"2025-11-06T21:20:00", note:"Set BBQ"},
      {id:"#TX2384", user:"An Ph·∫°m",     uid:"U009", type:"Expense", category:"Nh√† ·ªü",    method:"Vietcombank",amount:-3400000, status:"Success", time:"2025-11-05T14:05:00", note:"Ti·ªÅn nh√†"},
      {id:"#TX2383", user:"Duy B√πi",     uid:"U010", type:"Income",  category:"Kh√°c",     method:"ZaloPay",    amount: 1200000, status:"Success", time:"2025-11-04T11:45:00", note:"Freelance"},
      {id:"#TX2382", user:"Kh√°nh Tr·∫ßn",  uid:"U006", type:"Expense", category:"Gi·∫£i tr√≠", method:"Cash",       amount: -250000, status:"Review",  time:"2025-11-03T19:40:00", note:"Game"},
    ];

    /* ===== State ===== */
    let state = { q:'', range:30, status:'', type:'', method:'', quick:'', page:1, pageSize:8, selected:new Set() };

    /* ===== Elements ===== */
    const $ = id => document.getElementById(id);
    const tbody = $('tbody');
    const pageInfo = $('pageInfo');
    const resultInfo = $('resultInfo');
    const chkAll = $('chkAll');
    const bulkbar = $('bulkbar');
    const selCount = $('selCount');
    const overlay = $('overlay');
    const drawer = $('drawer');

    /* ===== Utils ===== */
    const fmtVND = n => n.toLocaleString('vi-VN');
    const fmtTime = iso => new Date(iso).toLocaleString('vi-VN');
    const moneyHTML = v => `<span class="amount ${v<0?'neg':'pos'}">${v<0?'- ':'+ '}${fmtVND(Math.abs(v))} ‚Ç´</span>`;
    const badge = s => s==='Success' ? '<span class="status s-ok">Success</span>' :
                       s==='Flagged' ? '<span class="status s-flag">Flagged</span>' :
                       s==='Failed'  ? '<span class="status s-fail">Failed</span>'  :
                                       '<span class="status s-review">Review</span>';

    function updateBulkbar(){
      bulkbar.classList.toggle('show', state.selected.size>0);
      selCount.textContent = state.selected.size;
    }

    function applyFilters(){
      const now = Date.now();
      let data = TXS.filter(tx => now - new Date(tx.time).getTime() <= state.range*24*3600*1000);

      // quick
      if(state.quick==='big')  data = data.filter(tx => Math.abs(tx.amount) > 5_000_000);
      if(state.quick==='flag') data = data.filter(tx => ['Flagged','Review'].includes(tx.status));
      if(state.quick==='fail') data = data.filter(tx => tx.status==='Failed');
      if(state.quick==='cash') data = data.filter(tx => tx.method==='Cash');

      // search
      if(state.q){
        const q = state.q.toLowerCase();
        data = data.filter(tx =>
          tx.id.toLowerCase().includes(q) ||
          tx.user.toLowerCase().includes(q) ||
          (tx.note||'').toLowerCase().includes(q)
        );
      }
      // filters
      if(state.status) data = data.filter(tx => tx.status===state.status);
      if(state.type)   data = data.filter(tx => tx.type===state.type);
      if(state.method) data = data.filter(tx => tx.method===state.method);

      // sort (m·ªõi nh·∫•t tr∆∞·ªõc)
      data.sort((a,b)=> new Date(b.time)-new Date(a.time));

      // pagination
      const total = data.length;
      const pages = Math.max(1, Math.ceil(total/state.pageSize));
      state.page = Math.min(state.page, pages);
      const start = (state.page-1)*state.pageSize;
      const view = data.slice(start, start+state.pageSize);

      // render
      tbody.innerHTML = view.map(tx=>`
        <tr data-id="${tx.id}">
          <td><input type="checkbox" class="chk-row" data-id="${tx.id}" ${state.selected.has(tx.id)?'checked':''}></td>
          <td class="mono">${tx.id}</td>
          <td><a class="link" href="nguoidung.html" title="${tx.uid}">${tx.user}</a></td>
          <td class="muted">${tx.type}</td>
          <td>${tx.category}</td>
          <td>${tx.method}</td>
          <td class="num">${moneyHTML(tx.amount)}</td>
          <td>${badge(tx.status)}</td>
          <td class="muted">${fmtTime(tx.time)}</td>
          <td><a href="#" class="link act-view" data-id="${tx.id}">Xem</a></td>
        </tr>
      `).join('');

      resultInfo.textContent = total
        ? `${start+1}-${Math.min(start+state.pageSize,total)} / ${total} giao d·ªãch`
        : 'Kh√¥ng c√≥ k·∫øt qu·∫£';
      pageInfo.textContent = `${state.page}/${pages}`;

      // header checkbox state
      const ids = Array.from(tbody.querySelectorAll('.chk-row')).map(i=>i.dataset.id);
      const allChecked = ids.length>0 && ids.every(id => state.selected.has(id));
      const noneChecked = ids.every(id => !state.selected.has(id));
      chkAll.checked = allChecked;
      chkAll.indeterminate = !allChecked && !noneChecked;

      updateBulkbar();
    }

    /* ===== Events: filters ===== */
    $('q').addEventListener('input', e=>{ state.q = e.target.value.trim(); state.page=1; applyFilters(); });
    $('fRange').addEventListener('change', e=>{ state.range = +e.target.value; state.page=1; applyFilters(); });
    $('fStatus').addEventListener('change', e=>{ state.status = e.target.value; state.page=1; applyFilters(); });
    $('fType').addEventListener('change', e=>{ state.type = e.target.value; state.page=1; applyFilters(); });
    $('fMethod').addEventListener('change', e=>{ state.method = e.target.value; state.page=1; applyFilters(); });
    $('btnClear').addEventListener('click', ()=>{
      state.q=''; $('q').value='';
      state.range=30; $('fRange').value='30';
      state.status=''; $('fStatus').value='';
      state.type=''; $('fType').value='';
      state.method=''; $('fMethod').value='';
      state.quick=''; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      state.page=1; state.selected.clear(); applyFilters();
    });

    // chips
    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        if(state.quick===ch.dataset.quick){ state.quick=''; }
        else { state.quick = ch.dataset.quick; ch.classList.add('active'); }
        state.page=1; applyFilters();
      });
    });

    // pagination
    $('prev').addEventListener('click', ()=>{ if(state.page>1){state.page--; applyFilters();}});
    $('next').addEventListener('click', ()=>{ state.page++; applyFilters();});

    // row selection
    tbody.addEventListener('change', e=>{
      if(e.target.classList.contains('chk-row')){
        const id = e.target.dataset.id;
        if(e.target.checked) state.selected.add(id); else state.selected.delete(id);
        updateBulkbar();
        // update header checkbox
        const ids = Array.from(tbody.querySelectorAll('.chk-row')).map(i=>i.dataset.id);
        const allChecked = ids.length>0 && ids.every(id => state.selected.has(id));
        const noneChecked = ids.every(id => !state.selected.has(id));
        chkAll.checked = allChecked;
        chkAll.indeterminate = !allChecked && !noneChecked;
      }
    });
    chkAll.addEventListener('change', ()=>{
      const ids = Array.from(tbody.querySelectorAll('.chk-row')).map(i=>i.dataset.id);
      if(chkAll.checked) ids.forEach(id=>state.selected.add(id));
      else ids.forEach(id=>state.selected.delete(id));
      applyFilters();
    });

    // open drawer
    tbody.addEventListener('click', e=>{
      if(e.target.classList.contains('act-view')){
        e.preventDefault();
        openDrawer(e.target.dataset.id);
      }
    });
    $('d_close').addEventListener('click', closeDrawer);
    $('overlay').addEventListener('click', closeDrawer);

    function openDrawer(id){
      const tx = TXS.find(t=>t.id===id); if(!tx) return;
      $('d_title').textContent = `Chi ti·∫øt ${tx.id}`;
      $('d_id').textContent = tx.id;
      $('d_user').textContent = `${tx.user} (${tx.uid})`;
      $('d_type').textContent = tx.type;
      $('d_cat').textContent = tx.category;
      $('d_method').textContent = tx.method;
      $('d_amount').innerHTML = moneyHTML(tx.amount);
      $('d_status').innerHTML = badge(tx.status);
      $('d_time').textContent = fmtTime(tx.time);
      $('d_note').textContent = tx.note || '‚Äî';

      $('d_mark').onclick = ()=>{ alert(`ƒê√£ ƒë√°nh d·∫•u ƒë√£ xem ${tx.id}`); };
      $('d_refund').onclick = ()=>{ alert(`G·ª≠i y√™u c·∫ßu ho√†n ti·ªÅn cho ${tx.id}`); };

      drawer.classList.add('show'); overlay.classList.add('show');
      drawer.setAttribute('aria-hidden','false'); overlay.setAttribute('aria-hidden','false');
    }
    function closeDrawer(){
      drawer.classList.remove('show'); overlay.classList.remove('show');
      drawer.setAttribute('aria-hidden','true'); overlay.setAttribute('aria-hidden','true');
    }

    // bulk actions
    $('bulkMark').addEventListener('click', ()=>{
      if(!state.selected.size) return;
      alert(`ƒê√£ ƒë√°nh d·∫•u ${state.selected.size} giao d·ªãch l√† ƒë√£ xem`);
      state.selected.clear(); applyFilters();
    });
    $('bulkExport').addEventListener('click', ()=>{
      // xu·∫•t CSV t·ª´ d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã tr√™n page (tbody)
      const rows = [['id','user','type','category','method','amount','status','time','note']];
      TXS.forEach(tx=>{
        // ch·ªâ export nh·ªØng item ƒëang l·ªçc trong kho·∫£ng & ƒëi·ªÅu ki·ªán
        const now = Date.now();
        if(now - new Date(tx.time).getTime() > state.range*24*3600*1000) return;
        if(state.quick==='big'  && !(Math.abs(tx.amount)>5_000_000)) return;
        if(state.quick==='flag' && !(['Flagged','Review'].includes(tx.status))) return;
        if(state.quick==='fail' && tx.status!=='Failed') return;
        if(state.quick==='cash' && tx.method!=='Cash') return;
        if(state.q){
          const q=state.q.toLowerCase();
          if(!(tx.id.toLowerCase().includes(q)||tx.user.toLowerCase().includes(q)||(tx.note||'').toLowerCase().includes(q))) return;
        }
        if(state.status && tx.status!==state.status) return;
        if(state.type   && tx.type!==state.type)     return;
        if(state.method && tx.method!==state.method) return;

        rows.push([tx.id, tx.user, tx.type, tx.category, tx.method, tx.amount, tx.status, tx.time, (tx.note||'')]);
      });
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `transactions_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // keyboard shortcuts
    window.addEventListener('keydown', e=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $('q').focus(); }
      if(e.key==='Escape'){ closeDrawer(); }
    });

    // init
    applyFilters();
  </script>
</body>
</html>
