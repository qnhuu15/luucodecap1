<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartExpense ‚Äì Admin / AI Insights</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ===== Design tokens ===== */
    :root{
      --bg:#ECF5FA; --panel:#FFFFFF; --text:#0F172A; --muted:#6B7280;
      --primary:#22C55E; --danger:#EF4444; --blue:#3B82F6;
      --border:#E2E8F0; --radius:14px; --shadow:0 8px 24px rgba(15,23,42,.06);
    }

    /* ===== Header UI Kit (ƒë·ªìng b·ªô) ===== */
    :root{
      --control-h:44px;
      --pill-radius:999px;
      --pill-grad:linear-gradient(180deg,#FFFFFF 0%,#F9FAFB 100%);
      --pill-shadow:inset 0 1px 0 #FFFFFF, 0 6px 16px rgba(15,23,42,.06);

      /* Typography header + khung tr·∫Øng */
      --title-size:24px;
      --title-weight:800;
      --title-tracking:.2px;
      --pill-font-size:15px;
    }
    header .page-title{
      margin:0;
      font: var(--title-weight) var(--title-size)/1.1 Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      letter-spacing:var(--title-tracking);
      color:var(--text);
    }
    header .search{position:relative; flex:1; max-width:720px}
    header .search input{
      width:100%; height:var(--control-h);
      border-radius:var(--pill-radius);
      border:1px solid var(--border);
      padding:0 14px 0 44px;
      background:var(--pill-grad);
      box-shadow:var(--pill-shadow);
      color:var(--text); outline:none;

      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      font-size:var(--pill-font-size);
      font-weight:600; line-height:1;
    }
    header .search input::placeholder{color:var(--muted); font-weight:500}
    header .search .icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);opacity:.6}
    header .btn, header .select{
      height:var(--control-h);
      border-radius:var(--pill-radius);
      border:1px solid var(--border);
      padding:0 14px;
      background:var(--pill-grad);
      box-shadow:var(--pill-shadow);
      cursor:pointer;

      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      font-size:var(--pill-font-size);
      font-weight:600; line-height:1; color:var(--text);
    }
    header .btn:hover, header .select:hover, header .search input:hover{ background:#F7FAFF; }
    header .btn[disabled]{opacity:.5;cursor:not-allowed}
    header .select{
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 8l4 4 4-4' stroke='%238A94A6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 12px center; padding-right:34px;
    }

    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}

    /* ===== Layout ===== */
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100dvh}
    aside{background:var(--panel);border-right:1px solid var(--border);padding:18px;position:sticky;top:0;height:100dvh}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px}
    .logo-badge{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#FFE9DE 0%,#FFF5EE 100%);box-shadow:0 6px 16px rgba(15,23,42,.08), inset 0 0 0 1px rgba(255,255,255,.6);display:block;overflow:hidden}
    .brand-logo{width:100%;height:100%;object-fit:contain}
    .nav{margin-top:16px;display:flex;flex-direction:column;gap:6px}
    .nav a{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);padding:10px 12px;border-radius:12px;transition:background .25s,transform .15s}
    .nav a .ic{width:22px}
    .nav a:hover{background:#F3F4F6;transform:translateX(2px)}
    .nav a.active{background:#A7EFC1;color:#065F46;font-weight:600}

    main{display:flex;flex-direction:column;min-width:0}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:12px 16px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    .toolbar{display:flex;align-items:center;gap:12px;flex:1;justify-content:center}
    .menu-btn{display:none}
    .search{position:relative;flex:1;max-width:720px}
    .btn{all:unset;cursor:pointer;background:#F3F4F6;border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-weight:600}
    .btn:hover{background:#EDF2F7}

    .content{padding:20px;display:grid;gap:16px}
    .card{background:var(--panel);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border)}

    /* ===== KPI ===== */
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:16px}
    .kpi{height:120px;display:flex;flex-direction:column;justify-content:space-between}
    .kpi .title{font-size:13px;color:var(--muted)}
    .kpi .value{font-size:28px;font-weight:700;line-height:1.1;font-variant-numeric:tabular-nums}
    .kpi .trend{font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;height:28px;padding:0 10px;border-radius:999px;font-size:12px;font-weight:700}
    .b-blue{background:#E0EDFF;color:#1D4ED8}
    .b-green{background:#DCFCE7;color:#065F46}
    .b-red{background:#FEE2E2;color:#991B1B}
    .b-yellow{background:#FEF9C3;color:#854D0E}

    /* ===== Chips + bulkbar ===== */
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{height:30px;padding:0 10px;border-radius:999px;background:#F3F4F6;border:1px solid var(--border);display:inline-flex;align-items:center;font-size:12px;cursor:pointer}
    .chip.active{background:#DCFCE7;color:#065F46;border-color:#86EFAC}
    .bulkbar{display:none;align-items:center;justify-content:space-between;gap:10px;background:#F8FAFC;border:1px dashed var(--border);padding:10px 12px;border-radius:12px}
    .bulkbar.show{display:flex}
    .small{font-size:12px;color:var(--muted)}

    /* ===== B·∫£ng ===== */
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:8px 10px}
    td{background:#fff;padding:12px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);vertical-align:middle}
    tr td:first-child{border-left:1px solid var(--border);border-radius:10px 0 0 10px}
    tr td:last-child{border-right:1px solid var(--border);border-radius:0 10px 10px 0}
    .num{font-variant-numeric:tabular-nums}
    .link{color:#2563EB;text-decoration:none;font-weight:600}
    .link:hover{text-decoration:underline}

    .sev{display:inline-flex;align-items:center;gap:8px}
    .sevbar{width:100px;height:8px;background:#F3F4F6;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .sevfill{height:100%;background:#EF4444}

    .status{display:inline-flex;align-items:center;height:26px;padding:0 10px;border-radius:999px;font-size:12px;font-weight:700}
    .s-open{background:#FEF9C3;color:#854D0E}
    .s-res{background:#DCFCE7;color:#065F46}
    .s-dis{background:#E5E7EB;color:#374151}
    .type{display:inline-flex;align-items:center;height:26px;padding:0 10px;border-radius:999px;font-size:12px;font-weight:700}
    .t-ano{background:#FEE2E2;color:#991B1B}
    .t-frd{background:#E0EDFF;color:#1D4ED8}
    .t-pat{background:#D1FAE5;color:#115E59}
    .t-fore{background:#F3E8FF;color:#6B21A8}

    .pag{display:flex;gap:8px;align-items:center}
    .pag .btn{padding:6px 10px}

    /* ===== Drawer + overlay ===== */
    .drawer{position:fixed;top:0;right:-520px;width:520px;height:100dvh;background:#fff;border-left:1px solid var(--border);box-shadow:-8px 0 24px rgba(15,23,42,.08);transition:right .25s;z-index:50;display:flex;flex-direction:column}
    .drawer.show{right:0}
    .drawer header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:14px 16px}
    .overlay{position:fixed;inset:0;background:rgba(15,23,42,.35);opacity:0;pointer-events:none;transition:opacity .2s;z-index:49}
    .overlay.show{opacity:1;pointer-events:auto}
    .kv{display:grid;grid-template-columns:150px 1fr;gap:10px}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}

    .spark{height:80px;width:100%;border:1px solid var(--border);border-radius:10px;background:linear-gradient(180deg,#FFFFFF 0%,#FBFBFD 100%)}

    @media (max-width:1000px){
      .app{grid-template-columns:1fr}
      aside{position:fixed;inset:0 40% 0 0;transform:translateX(-100%)}
      th:nth-child(5),td:nth-child(5), /* ·∫©n c·ªôt Target Id */
      th:nth-child(8),td:nth-child(8){display:none}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside>
      <div class="brand">
        <span class="logo-badge">
          <img class="brand-logo" src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt="SmartExpense" />
        </span>
        SmartExpense Admin
      </div>
      <nav class="nav" style="margin-top:14px">
        <a href="tongquan.html"><span class="ic">üè†</span> T·ªïng quan</a>
        <a href="nguoidung.html"><span class="ic">üë•</span> Ng∆∞·ªùi d√πng</a>
        <a href="giaodich.html"><span class="ic">üí≥</span> Giao d·ªãch</a>
        <a class="active" href="AI_Insights.html"><span class="ic">ü§ñ</span> AI Insights</a>
        <a href="baocao.html"><span class="ic">üìä</span> B√°o c√°o</a>
        <a href="#"><span class="ic">‚öôÔ∏è</span> C√†i ƒë·∫∑t</a>
        <a href="#"><span class="ic">üö™</span> ƒêƒÉng xu·∫•t</a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main>
      <header>
        <h2 class="page-title">AI Insights</h2>
        <div class="toolbar">
          <div class="search">
            <span class="icon">üîé</span>
            <input id="q" placeholder="T√¨m insight, ng∆∞·ªùi d√πng, ID..." aria-label="T√¨m ki·∫øm AI insights" />
          </div>

          <select id="fRange" class="select" title="Kho·∫£ng th·ªùi gian">
            <option value="24">24 gi·ªù</option>
            <option value="7">7 ng√†y</option>
            <option value="30" selected>30 ng√†y</option>
            <option value="90">90 ng√†y</option>
          </select>
          <select id="fType" class="select" title="Lo·∫°i insight">
            <option value="">T·∫•t c·∫£ lo·∫°i</option>
            <option value="Anomaly">Anomaly</option>
            <option value="Fraud">Fraud</option>
            <option value="Pattern">Pattern</option>
            <option value="Forecast">Forecast</option>
          </select>
          <select id="fStatus" class="select" title="Tr·∫°ng th√°i">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="Open">Open</option>
            <option value="Resolved">Resolved</option>
            <option value="Dismissed">Dismissed</option>
          </select>
          <button class="btn" id="btnRerun" title="Ch·∫°y l·∫°i ph√¢n t√≠ch">‚Üª Re-run</button>
          <button class="btn" id="btnClear" title="X√≥a t·∫•t c·∫£ b·ªô l·ªçc">X√≥a l·ªçc</button>
        </div>
      </header>

      <div class="content">
        <!-- KPI -->
        <section class="kpis">
          <div class="card kpi">
            <div class="title">C·∫£nh b√°o ƒëang m·ªü</div>
            <div class="value num" id="k_open">‚Äî</div>
            <div class="trend"><span class="badge b-yellow">‚óè +12% so v·ªõi 7d</span></div>
          </div>
          <div class="card kpi">
            <div class="title">ƒêi·ªÉm r·ªßi ro trung b√¨nh</div>
            <div class="value num" id="k_risk">‚Äî</div>
            <div class="trend"><span class="badge b-blue">M·ª•c ti√™u &lt; 0.65</span></div>
          </div>
          <div class="card kpi">
            <div class="title">Giao d·ªãch nghi v·∫•n (7d)</div>
            <div class="value num" id="k_susp">‚Äî</div>
            <div class="trend"><span class="badge b-red">‚ö† c·∫ßn xem</span></div>
          </div>
          <div class="card kpi">
            <div class="title">ƒê·ªô ch√≠nh x√°c m√¥ h√¨nh (7d)</div>
            <div class="value num" id="k_acc">‚Äî</div>
            <div class="trend"><span class="badge b-green">‚Üë ·ªïn ƒë·ªãnh</span></div>
          </div>
        </section>

        <!-- Quick chips -->
        <div class="card" style="padding:12px">
          <div class="chips">
            <span class="chip" data-quick="sev85">üî• Severity ‚â• 0.85</span>
            <span class="chip" data-quick="recent24">üÜï Trong 24 gi·ªù</span>
            <span class="chip" data-quick="unresolved">‚ö†Ô∏è Ch∆∞a x·ª≠ l√Ω</span>
            <span class="chip" data-quick="userlvl">üë§ M·ª©c ng∆∞·ªùi d√πng</span>
          </div>
        </div>

        <!-- Bulk bar -->
        <div id="bulkbar" class="bulkbar" aria-live="polite">
          <div><strong id="selCount">0</strong> insight ƒë√£ ch·ªçn</div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="bulkResolve">Mark Resolved</button>
            <button class="btn" id="bulkDismiss">Dismiss</button>
            <button class="btn" id="bulkExport">Xu·∫•t CSV</button>
          </div>
        </div>

        <!-- List + Right -->
        <section class="card">
          <h3 style="margin:0 0 12px 0">Danh s√°ch insights</h3>
          <table>
            <thead>
              <tr>
                <th style="width:36px"><input type="checkbox" id="chkAll" aria-label="Ch·ªçn t·∫•t c·∫£"></th>
                <th>ID</th>
                <th>Lo·∫°i</th>
                <th>Target</th>
                <th>Target ID</th>
                <th>Severity</th>
                <th>Confidence</th>
                <th>Tr·∫°ng th√°i</th>
                <th>T·∫°o l√∫c</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div class="small" id="resultInfo">‚Äî</div>
            <div class="pag">
              <button class="btn" id="prev">‚óÄ</button>
              <span class="small" id="pageInfo">1/1</span>
              <button class="btn" id="next">‚ñ∂</button>
            </div>
          </div>
        </section>

        <!-- Overview (mini charts) -->
        <section class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="card">
            <h3 style="margin:0 0 12px 0">Xu h∆∞·ªõng c·∫£nh b√°o</h3>
            <canvas id="trendChart" class="spark"></canvas>
          </div>
          <div class="card">
            <h3 style="margin:0 0 12px 0">Ph√¢n b·ªë m·ª©c ƒë·ªô (bins)</h3>
            <canvas id="histChart" class="spark"></canvas>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Overlay + Drawer -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>
  <div id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-modal="true">
    <header>
      <strong id="d_title">Chi ti·∫øt insight</strong>
      <button class="btn" id="d_close">‚úï</button>
    </header>
    <div style="padding:16px;display:grid;gap:16px;overflow:auto">
      <div class="kv">
        <div class="muted">Insight ID</div><div id="d_id" class="mono"></div>
        <div class="muted">Lo·∫°i</div><div id="d_type"></div>
        <div class="muted">Target</div><div id="d_target"></div>
        <div class="muted">Severity</div><div id="d_sev"></div>
        <div class="muted">Confidence</div><div id="d_conf"></div>
        <div class="muted">Tr·∫°ng th√°i</div><div id="d_status"></div>
        <div class="muted">Th·ªùi gian</div><div id="d_time"></div>
        <div class="muted">Model</div><div id="d_model"></div>
      </div>

      <div class="card" style="padding:12px">
        <h4 style="margin:0 0 8px 0">Gi·∫£i th√≠ch (feature impact)</h4>
        <div id="d_explain"></div>
      </div>

      <div class="card" style="padding:12px">
        <h4 style="margin:0 0 8px 0">Khuy·∫øn ngh·ªã</h4>
        <ul id="d_reco" style="margin:0 0 0 18px; padding:0; display:grid; gap:6px"></ul>
      </div>

      <div style="display:flex;gap:8px">
        <button class="btn" id="d_resolve">Mark Resolved</button>
        <button class="btn" id="d_dismiss">Dismiss</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== Demo data ===== */
    const INSIGHTS = [
      {
        id:"AI-20251108-001", type:"Anomaly", targetType:"User", targetName:"Minh V√µ", targetId:"U001",
        severity:0.91, confidence:0.88, status:"Open", created:"2025-11-08T18:10:00", model:"XGBoost-v2",
        explain:[["Chi ti√™u gi·ªù khuya",0.31],["T·∫ßn su·∫•t >3x/24h",0.27],["S·ªë th·∫ª li√™n k·∫øt",0.18],["Kho·∫£ng c√°ch IP",0.12]],
        reco:["Y√™u c·∫ßu x√°c minh KYC b·ªï sung","Gi·ªõi h·∫°n t·∫°m th·ªùi h·∫°n m·ª©c giao d·ªãch 24h","G·ª≠i th√¥ng b√°o c·∫£nh b√°o t·ªõi ng∆∞·ªùi d√πng"]
      },
      {
        id:"AI-20251108-002", type:"Fraud", targetType:"Transaction", targetName:"#TX2388", targetId:"#TX2388",
        severity:0.86, confidence:0.92, status:"Open", created:"2025-11-08T17:52:00", model:"FraudNet-bert",
        explain:[["Thi·∫øt b·ªã m·ªõi",0.29],["IP l·∫°",0.22],["S·ªë ti·ªÅn l·ªõn",0.21],["L·ªãch s·ª≠ chargeback",0.17]],
        reco:["T·∫°m gi·ªØ giao d·ªãch, y√™u c·∫ßu x√°c nh·∫≠n OTP b·ªï sung","Ki·ªÉm tra danh s√°ch IP r·ªßi ro"]
      },
      {
        id:"AI-20251107-003", type:"Pattern", targetType:"User", targetName:"My L√™", targetId:"U008",
        severity:0.56, confidence:0.73, status:"Resolved", created:"2025-11-07T09:20:00", model:"Cluster-KMeans",
        explain:[["C·ª•m chi ti√™u gi·∫£i tr√≠",0.34],["Bi·∫øn ƒë·ªông thu nh·∫≠p",0.19],["S·ªë d∆∞ v√≠",0.12]],
        reco:["G·ª£i √Ω ng√¢n s√°ch Gi·∫£i tr√≠ 1.000.000 ‚Ç´/th√°ng","ƒê·ªÅ xu·∫•t g√≥i ti·∫øt ki·ªám ph√π h·ª£p"]
      },
      {
        id:"AI-20251106-004", type:"Forecast", targetType:"Category", targetName:"Nh√† ·ªü", targetId:"CAT-HOUSING",
        severity:0.41, confidence:0.81, status:"Dismissed", created:"2025-11-06T16:05:00", model:"Prophet-v1",
        explain:[["Xu h∆∞·ªõng m√πa v·ª•",0.44],["M·ªëc thanh to√°n ƒë·ªãnh k·ª≥",0.33]],
        reco:["Nh·∫Øc thanh to√°n h√≥a ƒë∆°n s·ªõm 3 ng√†y","ƒê·ªÅ xu·∫•t chia nh·ªè kho·∫£n chi ƒë·ªÉ tr√°nh ƒë·ªôt bi·∫øn"]
      },
      {
        id:"AI-20251108-005", type:"Anomaly", targetType:"User", targetName:"Kh√°nh Tr·∫ßn", targetId:"U006",
        severity:0.72, confidence:0.69, status:"Open", created:"2025-11-08T13:15:00", model:"XGBoost-v2",
        explain:[["Bi·∫øn ƒë·ªông t·∫ßn su·∫•t",0.26],["Ngu·ªìn thi·∫øt b·ªã",0.23],["H·∫°n m·ª©c m·ªõi",0.17]],
        reco:["Theo d√µi th√™m 24 gi·ªù","Gi·ªõi h·∫°n s·ªë l·∫ßn r√∫t ti·ªÅn qua Momo"]
      }
    ];

    /* ===== State ===== */
    let state = { q:'', range:30, type:'', status:'', quick:'', page:1, pageSize:7, selected:new Set() };

    /* ===== Elements ===== */
    const $ = id => document.getElementById(id);
    const tbody = $('tbody');
    const pageInfo = $('pageInfo');
    const resultInfo = $('resultInfo');
    const chkAll = $('chkAll');
    const bulkbar = $('bulkbar');
    const selCount = $('selCount');
    const overlay = $('overlay');
    const drawer = $('drawer');

    /* ===== Utils ===== */
    const pct = x => Math.round(x*100);
    const fmtTime = iso => new Date(iso).toLocaleString('vi-VN');
    const typeBadge = t => t==="Anomaly" ? '<span class="type t-ano">Anomaly</span>' :
                         t==="Fraud"   ? '<span class="type t-frd">Fraud</span>'   :
                         t==="Pattern" ? '<span class="type t-pat">Pattern</span>' :
                                         '<span class="type t-fore">Forecast</span>';
    const statusBadge = s => s==="Open" ? '<span class="status s-open">Open</span>' :
                           s==="Resolved" ? '<span class="status s-res">Resolved</span>' :
                                            '<span class="status s-dis">Dismissed</span>';
    const sevBar = v => {
      const w = Math.max(2, Math.min(100, Math.round(v*100)));
      const color = v>=0.85 ? '#B91C1C' : v>=0.7 ? '#EA580C' : '#16A34A';
      return `<div class="sev"><div class="sevbar"><div class="sevfill" style="width:${w}%;background:${color}"></div></div><strong>${v.toFixed(2)}</strong></div>`;
    }

    function updateKPI(filtered){
      const open = filtered.filter(x=>x.status==='Open').length;
      const riskAvg = filtered.length ? (filtered.reduce((s,x)=>s+x.severity,0)/filtered.length) : 0;
      const susp7 = filtered.filter(x=>x.type==='Fraud' || (x.type==='Anomaly' && x.severity>=0.85)).length;
      const acc = 0.93; // demo
      $('k_open').textContent = open.toLocaleString('vi-VN');
      $('k_risk').textContent = riskAvg.toFixed(2);
      $('k_susp').textContent = susp7.toLocaleString('vi-VN');
      $('k_acc').textContent = (acc*100).toFixed(1)+'%';
    }

    function updateBulkbar(){
      bulkbar.classList.toggle('show', state.selected.size>0);
      selCount.textContent = state.selected.size;
    }

    function applyFilters(){
      const now = Date.now();
      let data = INSIGHTS.filter(i => (now - new Date(i.created).getTime()) <= state.range*24*3600*1000);

      // quick chips
      if(state.quick==='sev85') data = data.filter(i=>i.severity>=0.85);
      if(state.quick==='recent24') data = data.filter(i=> (now - new Date(i.created).getTime()) <= 24*3600*1000);
      if(state.quick==='unresolved') data = data.filter(i=>i.status==='Open');
      if(state.quick==='userlvl') data = data.filter(i=>i.targetType==='User');

      // search
      if(state.q){
        const q = state.q.toLowerCase();
        data = data.filter(i =>
          i.id.toLowerCase().includes(q) ||
          i.targetName.toLowerCase().includes(q) ||
          i.targetId.toLowerCase().includes(q) ||
          i.type.toLowerCase().includes(q)
        );
      }
      // filters
      if(state.type) data = data.filter(i=>i.type===state.type);
      if(state.status) data = data.filter(i=>i.status===state.status);

      // sort m·ªõi nh·∫•t
      data.sort((a,b)=> new Date(b.created)-new Date(a.created));

      // KPI
      updateKPI(data);

      // pagination
      const total = data.length;
      const pages = Math.max(1, Math.ceil(total/state.pageSize));
      state.page = Math.min(state.page, pages);
      const start = (state.page-1)*state.pageSize;
      const view = data.slice(start, start+state.pageSize);

      // render table
      tbody.innerHTML = view.map(i=>`
        <tr data-id="${i.id}">
          <td><input type="checkbox" class="chk-row" data-id="${i.id}" ${state.selected.has(i.id)?'checked':''}></td>
          <td class="mono">${i.id}</td>
          <td>${typeBadge(i.type)}</td>
          <td>${i.targetType} ‚Äî <strong>${i.targetName}</strong></td>
          <td class="mono">${i.targetId}</td>
          <td>${sevBar(i.severity)}</td>
          <td class="num">${pct(i.confidence)}%</td>
          <td>${statusBadge(i.status)}</td>
          <td class="muted">${fmtTime(i.created)}</td>
          <td><a href="#" class="link act-view" data-id="${i.id}">Xem</a></td>
        </tr>
      `).join('');

      $('resultInfo').textContent = total
        ? `${start+1}-${Math.min(start+state.pageSize,total)} / ${total} insights`
        : 'Kh√¥ng c√≥ k·∫øt qu·∫£';
      $('pageInfo').textContent = `${state.page}/${pages}`;

      // header checkbox state
      const ids = Array.from(tbody.querySelectorAll('.chk-row')).map(i=>i.dataset.id);
      const allChecked = ids.length>0 && ids.every(id => state.selected.has(id));
      const noneChecked = ids.every(id => !state.selected.has(id));
      chkAll.checked = allChecked;
      chkAll.indeterminate = !allChecked && !noneChecked;

      updateBulkbar();

      // refresh mini charts
      drawTrend(data);
      drawHist(data);
    }

    /* ===== Events: filters ===== */
    $('q').addEventListener('input', e=>{ state.q = e.target.value.trim(); state.page=1; applyFilters(); });
    $('fRange').addEventListener('change', e=>{ state.range = +e.target.value; state.page=1; applyFilters(); });
    $('fType').addEventListener('change', e=>{ state.type = e.target.value; state.page=1; applyFilters(); });
    $('fStatus').addEventListener('change', e=>{ state.status = e.target.value; state.page=1; applyFilters(); });
    $('btnClear').addEventListener('click', ()=>{
      state.q=''; $('q').value='';
      state.range=30; $('fRange').value='30';
      state.type=''; $('fType').value='';
      state.status=''; $('fStatus').value='';
      state.quick=''; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      state.page=1; state.selected.clear(); applyFilters();
    });
    $('btnRerun').addEventListener('click', ()=> alert('ƒê√£ g·ª≠i y√™u c·∫ßu ch·∫°y l·∫°i ph√¢n t√≠ch AI (demo)'));

    // chips
    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        if(state.quick===ch.dataset.quick){ state.quick=''; }
        else { state.quick = ch.dataset.quick; ch.classList.add('active'); }
        state.page=1; applyFilters();
      });
    });

    // pagination
    $('prev').addEventListener('click', ()=>{ if(state.page>1){state.page--; applyFilters();}});
    $('next').addEventListener('click', ()=>{ state.page++; applyFilters();});

    // row selection
    tbody.addEventListener('change', e=>{
      if(e.target.classList.contains('chk-row')){
        const id = e.target.dataset.id;
        if(e.target.checked) state.selected.add(id); else state.selected.delete(id);
        // update header checkbox
        const ids = Array.from(tbody.querySelectorAll('.chk-row')).map(i=>i.dataset.id);
        const allChecked = ids.length>0 && ids.every(id => state.selected.has(id));
        const noneChecked = ids.every(id => !state.selected.has(id));
        chkAll.checked = allChecked;
        chkAll.indeterminate = !allChecked && !noneChecked;
        updateBulkbar();
      }
    });
    chkAll.addEventListener('change', ()=>{
      const ids = Array.from(tbody.querySelectorAll('.chk-row')).map(i=>i.dataset.id);
      if(chkAll.checked) ids.forEach(id=>state.selected.add(id));
      else ids.forEach(id=>state.selected.delete(id));
      applyFilters();
    });

    // open drawer
    tbody.addEventListener('click', e=>{
      if(e.target.classList.contains('act-view')){
        e.preventDefault();
        openDrawer(e.target.dataset.id);
      }
    });
    $('d_close').addEventListener('click', closeDrawer);
    $('overlay').addEventListener('click', closeDrawer);

    function openDrawer(id){
      const it = INSIGHTS.find(t=>t.id===id); if(!it) return;
      $('d_title').textContent = `Insight ${it.id}`;
      $('d_id').textContent = it.id;
      $('d_type').innerHTML = typeBadge(it.type);
      $('d_target').textContent = `${it.targetType} ‚Äî ${it.targetName} (${it.targetId})`;
      $('d_sev').innerHTML = sevBar(it.severity);
      $('d_conf').textContent = pct(it.confidence)+'%';
      $('d_status').innerHTML = statusBadge(it.status);
      $('d_time').textContent = fmtTime(it.created);
      $('d_model').textContent = it.model;

      // explain
      $('d_explain').innerHTML = it.explain.map(([k,w])=>{
        const width = Math.round(w*100);
        return `
          <div style="display:flex;align-items:center;gap:8px;margin:6px 0">
            <div style="min-width:180px">${k}</div>
            <div style="flex:1;height:8px;background:#F3F4F6;border:1px solid var(--border);border-radius:999px;overflow:hidden">
              <div style="height:100%;width:${width}%;background:#22C55E"></div>
            </div>
            <div class="num" style="min-width:40px;text-align:right">${width}%</div>
          </div>
        `;
      }).join('');

      $('d_reco').innerHTML = it.reco.map(r=>`<li>${r}</li>`).join('');

      $('d_resolve').onclick = ()=>{ it.status='Resolved'; applyFilters(); openDrawer(id); };
      $('d_dismiss').onclick = ()=>{ it.status='Dismissed'; applyFilters(); openDrawer(id); };

      drawer.classList.add('show'); overlay.classList.add('show');
      drawer.setAttribute('aria-hidden','false'); overlay.setAttribute('aria-hidden','false');
    }
    function closeDrawer(){
      drawer.classList.remove('show'); overlay.classList.remove('show');
      drawer.setAttribute('aria-hidden','true'); overlay.setAttribute('aria-hidden','true');
    }

    // bulk actions
    $('bulkResolve').addEventListener('click', ()=>{
      INSIGHTS.forEach(x=>{ if(state.selected.has(x.id)) x.status='Resolved'; });
      state.selected.clear(); applyFilters();
    });
    $('bulkDismiss').addEventListener('click', ()=>{
      INSIGHTS.forEach(x=>{ if(state.selected.has(x.id)) x.status='Dismissed'; });
      state.selected.clear(); applyFilters();
    });
    $('bulkExport').addEventListener('click', ()=>{
      const rows = [['id','type','targetType','targetName','targetId','severity','confidence','status','created','model']];
      const now = Date.now();
      INSIGHTS.forEach(i=>{
        if(now - new Date(i.created).getTime() > state.range*24*3600*1000) return;
        if(state.quick==='sev85' && !(i.severity>=0.85)) return;
        if(state.quick==='recent24' && !(now - new Date(i.created).getTime() <= 24*3600*1000)) return;
        if(state.quick==='unresolved' && i.status!=='Open') return;
        if(state.quick==='userlvl' && i.targetType!=='User') return;
        if(state.q){
          const q=state.q.toLowerCase();
          if(!(i.id.toLowerCase().includes(q)||i.targetName.toLowerCase().includes(q)||i.targetId.toLowerCase().includes(q)||i.type.toLowerCase().includes(q))) return;
        }
        if(state.type && i.type!==state.type) return;
        if(state.status && i.status!==state.status) return;
        rows.push([i.id,i.type,i.targetType,i.targetName,i.targetId,i.severity,i.confidence,i.status,i.created,i.model]);
      });
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `ai_insights_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(a.href);
    });

    // keyboard
    window.addEventListener('keydown', e=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $('q').focus(); }
      if(e.key==='Escape'){ closeDrawer(); }
    });

    /* ===== Mini charts (no libs) ===== */
    const trend = $('trendChart').getContext('2d');
    const hist  = $('histChart').getContext('2d');
    function sizeCanvas(canvas){
      const dpr = window.devicePixelRatio || 1;
      const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
      canvas.width = Math.round(cssW*dpr); canvas.height = Math.round(cssH*dpr);
      const ctx = canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
      return {W:cssW,H:cssH,ctx};
    }
    function drawTrend(data){
      const {W,H,ctx} = sizeCanvas($('trendChart'));
      const pad=12;
      ctx.clearRect(0,0,W,H);
      const days=10;
      // ƒë·∫øm s·ªë insight theo ng√†y (gi·∫£n l∆∞·ª£c)
      const buckets = Array.from({length:days}, (_,i)=> i).map(i=>{
        const d = new Date(); d.setDate(d.getDate()-(days-1-i));
        const key = d.toISOString().slice(0,10);
        return {key, val: data.filter(x=>x.created.slice(0,10)===key).length};
      });
      const max = Math.max(1, ...buckets.map(b=>b.val));
      const step = (W-pad*2)/(days-1);
      // grid
      ctx.strokeStyle='#E5E7EB'; ctx.lineWidth=1;
      for(let i=0;i<3;i++){ const y=pad+(H-pad*2)/2*i; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke(); }
      // area + line
      const pts = buckets.map((b,i)=>[pad+step*i, H-pad - (b.val/max)*(H-pad*2)]);
      const grad = ctx.createLinearGradient(0,pad,0,H-pad);
      grad.addColorStop(0,'rgba(34,197,94,.25)'); grad.addColorStop(1,'rgba(34,197,94,0)');
      ctx.beginPath(); ctx.moveTo(pts[0][0],H-pad); pts.forEach(([x,y])=>ctx.lineTo(x,y)); ctx.lineTo(pts.at(-1)[0],H-pad); ctx.closePath(); ctx.fillStyle=grad; ctx.fill();
      ctx.beginPath(); pts.forEach(([x,y],i)=> i?ctx.lineTo(x,y):ctx.moveTo(x,y)); ctx.strokeStyle='#22C55E'; ctx.lineWidth=2; ctx.stroke();
    }
    function drawHist(data){
      const {W,H,ctx} = sizeCanvas($('histChart'));
      ctx.clearRect(0,0,W,H);
      const pad=14, bins=8;
      const counts = Array.from({length:bins},()=>0);
      data.forEach(i=>{ const b = Math.min(bins-1, Math.floor(i.severity*bins)); counts[b]++; });
      const max = Math.max(1, ...counts);
      const bw = (W-pad*2)/bins*0.8, gap=(W-pad*2)/bins*0.2;
      ctx.strokeStyle='#E5E7EB'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();
      counts.forEach((c,idx)=>{
        const x = pad + idx*(bw+gap);
        const h = (c/max)*(H-pad*2);
        ctx.fillStyle = '#3B82F6';
        ctx.fillRect(x, H-pad-h, bw, h);
      });
    }
    window.addEventListener('resize', ()=>applyFilters());

    // init
    applyFilters();
  </script>
</body>
</html>
