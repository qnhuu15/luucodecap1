<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title data-i18n="page.title">SmartExpense ‚Äî C·∫£nh b√°o ƒëƒÉng nh·∫≠p b·∫•t th∆∞·ªùng</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eaf3f9; --card:#fff; --text:#0f172a; --muted:#64748b;
    --border:#e5e7eb; --blue:#2563eb; --blue-700:#1e49d6; --green:#22c55e;
    --yellow:#f59e0b; --red:#ef4444;
    --radius:14px; --shadow:0 10px 26px rgba(15,23,42,.06);
    --h:44px;
  }
  /* Dark theme */
  html.dark{
    --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#9aa4b2;
    --border:#1f2a44; --blue:#3b82f6; --green:#22c55e;
    --yellow:#f59e0b; --red:#ef4444;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:grid;grid-template-columns:260px 1fr;min-height:100vh;
  }

  /* Sidebar */
  .sidebar{background:var(--card);border-right:1px solid var(--border);padding:18px 14px}
  .brand{display:flex;align-items:center;gap:12px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
  .brand .logo{width:40px;height:40px;border-radius:10px;overflow:hidden;background:#ffe8e0;display:grid;place-items:center;box-shadow:var(--shadow)}
  .brand .logo img{width:100%;height:100%;object-fit:cover}
  .brand b{font-size:18px;color:var(--text)}
  .nav{display:flex;flex-direction:column;gap:6px}
  .nav a{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;color:var(--text);font-weight:700;text-decoration:none}
  .nav a.active{background:var(--blue);color:#fff}
  .nav a:hover{background:rgba(37,99,235,.12)}

  /* Main */
  .main{padding:22px 24px 40px}
  .wrap{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:18px 18px 12px;max-width:1200px}
  .header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:8px}
  .title{font-size:24px;font-weight:800;margin:0;color:var(--text)}
  .tools{display:flex;gap:10px;flex-wrap:wrap}
  .chip{height:34px;border-radius:999px;border:1px solid var(--border);background:var(--card);color:var(--text);font-weight:800;padding:0 12px;cursor:pointer}
  .chip.active{background:#0f172a;color:#fff;border-color:#0f172a}
  html.dark .chip.active{background:#111827}
  .search{display:flex;gap:8px}
  .input{height:38px;border:1px solid var(--border);border-radius:999px;background:#f8fafc;display:flex;align-items:center;padding:0 12px}
  html.dark .input{background:#0b1220}
  .input input{border:0;outline:none;background:transparent;height:100%;color:var(--text)}

  .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;margin-top:8px}

  /* left list */
  .bar{display:flex;gap:10px;align-items:center;margin:8px 0}
  .btn{height:38px;border-radius:10px;padding:0 12px;font-weight:800;cursor:pointer}
  .btn-ghost{background:var(--card);border:1px solid var(--border);color:var(--text)}
  .btn-primary{background:var(--blue);color:#fff;border:0}
  .btn-primary:disabled{opacity:.6;cursor:not-allowed}
  .btn-danger{background:var(--card);border:1px solid #fecaca;color:#b91c1c}
  .btn-soft{background:#f1f5f9;border:1px solid #e2e8f0}
  html.dark .btn-soft{background:#0b1220;border-color:var(--border);color:var(--text)}
  .count{color:var(--muted);font-size:14px;margin-left:auto}

  .list{display:grid;gap:10px}
  .row{
    display:grid;grid-template-columns:28px 1fr 120px 84px 120px;gap:10px;
    align-items:center;border:1px solid var(--border);background:var(--card);border-radius:12px;padding:10px;
  }
  .row.active{outline:2px solid #9aa5b1}
  .sev{width:10px;height:10px;border-radius:50%}
  .sev.low{background:var(--green)} .sev.med{background:var(--yellow)} .sev.high{background:var(--red)}
  .dev{font-weight:800}
  .sub{color:var(--muted)}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;background:var(--card);color:var(--text)}
  .badge.trusted{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
  .badge.new{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}
  .badge.alert{background:#fff1f2;border-color:#fecdd3;color:#b91c1c}
  .row .time{text-align:right;color:var(--muted)}

  /* right detail */
  .panel{border-left:2px solid var(--border);padding-left:12px}
  .panel h3{margin:4px 0 10px;font-size:18px;font-weight:800}
  .kv{display:grid;grid-template-columns:120px 1fr;gap:6px;font-size:14px;margin:6px 0}
  .map{height:180px;border:1px dashed var(--border);border-radius:12px;background:
      linear-gradient(135deg,#f3f4f6,var(--card));display:grid;place-items:center;color:var(--muted);margin-top:8px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .hint{color:var(--muted);font-size:13px;margin-top:6px}

  /* Chatbox */
  .pig-float{
    position:fixed;right:26px;bottom:26px;width:76px;height:76px;border-radius:18px;
    background:#ffe8e0;display:grid;place-items:center;box-shadow:var(--shadow);
    z-index:30;border:0;cursor:pointer
  }
  .pig-float img{width:64px;height:64px}
  .chatbox{
    position:fixed;right:26px;bottom:112px;width:340px;background:var(--card);border:1px solid var(--border);
    border-radius:14px;box-shadow:var(--shadow);overflow:hidden;display:none;z-index:40;grid-template-rows:56px 1fr 60px;
  }
  .chatbox.open{display:grid}
  .chat-head{background:#1da1c9;color:#fff;display:flex;align-items:center;gap:10px;padding:10px 12px;font-weight:800}
  .chat-head img{width:28px;height:28px;border-radius:6px;background:#ffe8e0}
  .chat-title{line-height:1.2}
  .chat-body{background:#f4fbff;overflow:auto;padding:10px;max-height:380px}
  html.dark .chat-body{background:#0b1220}
  .msg{display:flex;align-items:flex-end;margin:8px 0;gap:8px}
  .bubble{max-width:78%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:#fff;font-size:14px;color:#0f172a}
  html.dark .bubble{background:var(--card);color:var(--text)}
  .msg.user{justify-content:flex-end}
  .msg.user .bubble{background:var(--blue);border:none;color:#fff}
  .avatar-s{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;background:#ffe8e0;flex:0 0 26px;font-size:14px}
  .chat-input{background:var(--card);border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;padding:8px}
  #chatInput{flex:1;height:40px;border:1px solid var(--border);border-radius:999px;padding:0 12px;outline:none;background:#fff;color:#0f172a}
  html.dark #chatInput{background:transparent;color:var(--text)}
  #sendBtn{width:38px;height:38px;border-radius:999px;border:0;background:var(--blue);color:#fff;display:grid;place-items:center;cursor:pointer}

  @media (max-width:1100px){
    body{grid-template-columns:1fr}
    .sidebar{position:sticky;top:0;z-index:20}
    .wrap{max-width:none}
    .grid{grid-template-columns:1fr}
    .panel{border-left:0;border-top:2px solid var(--border);padding-left:0;padding-top:12px}
    .chatbox{right:16px;bottom:96px;width:min(92vw,360px)}
    .pig-float{right:16px}
  }
</style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"><img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt=""></div>
      <b>SmartExpense</b>
    </div>
    <nav class="nav">
      <a href="trangchu.html">üè† <span data-i18n="nav.overview">T·ªïng quan</span></a>
      <a href="danhsachchitieu.html">üßæ <span data-i18n="nav.list">Danh s√°ch chi ti√™u</span></a>
      <a href="lichsuchitieu.html">üïò <span data-i18n="nav.history">L·ªãch s·ª≠ chi ti√™u</span></a>
      <a href="#">üìÖ <span data-i18n="nav.schedule">L√™n l·ªãch chi ti√™u</span></a>
      <a href="loaichitieu.html">üè∑Ô∏è <span data-i18n="nav.types">Lo·∫°i chi ti√™u</span></a>
      <a href="baocao.html">üìä <span data-i18n="nav.report">B√°o c√°o</span></a>
      <a href="hoso.html">üë§ <span data-i18n="nav.profile">H·ªì s∆°</span></a>
      <a href="caidat.html" class="active">‚öôÔ∏è <span data-i18n="nav.settings">C√†i ƒë·∫∑t</span></a>
      <a href="login.html">‚Ü™Ô∏è <span data-i18n="nav.logout">ƒêƒÉng xu·∫•t</span></a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="wrap">
      <div class="header">
        <h1 class="title" data-i18n="page.h1">C·∫£nh b√°o ƒëƒÉng nh·∫≠p b·∫•t th∆∞·ªùng</h1>
        <div class="tools">
          <button class="chip active" data-filter="all" data-i18n="filter.all">T·∫•t c·∫£</button>
          <button class="chip" data-filter="anomaly" data-i18n="filter.anomaly">B·∫•t th∆∞·ªùng</button>
          <button class="chip" data-filter="ok" data-i18n="filter.ok">B√¨nh th∆∞·ªùng</button>
          <div class="search">
            <div class="input">
              <input id="q" data-i18n="ph.search" placeholder="T√¨m theo IP, thi·∫øt b·ªã, v·ªã tr√≠‚Ä¶">
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- List -->
        <section>
          <div class="bar">
            <button id="markReviewed" class="btn btn-ghost" disabled data-i18n="btn.reviewed">ƒê√°nh d·∫•u ƒë√£ xem</button>
            <button id="logoutSelected" class="btn btn-danger" disabled data-i18n="btn.remoteLogout">ƒêƒÉng xu·∫•t t·ª´ xa</button>
            <button id="exportCsv" class="btn btn-soft" data-i18n="btn.exportCsv">Xu·∫•t CSV</button>
            <div class="count" id="countLabel">0 phi√™n</div>
          </div>
          <div class="list" id="list"></div>
        </section>

        <!-- Detail -->
        <aside class="panel">
          <h3 data-i18n="detail.title">Chi ti·∫øt ƒëƒÉng nh·∫≠p</h3>
          <div id="detail">
            <!-- Filled by JS -->
          </div>
        </aside>
      </div>
    </div>
  </main>

  <!-- Chatbox -->
  <div id="chatbox" class="chatbox" aria-hidden="true">
    <div class="chat-head">
      <img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt="">
      <div>
        <div class="chat-title" data-i18n="chat.title">Tr·ª£ l√Ω th√¥ng minh</div>
        <div class="chat-sub" data-i18n="chat.context">C·∫£nh b√°o ƒëƒÉng nh·∫≠p & b·∫£o m·∫≠t</div>
      </div>
    </div>
    <div id="chatBody" class="chat-body"></div>
    <div class="chat-input">
      <input id="chatInput" type="text" data-i18n="ph.chat" placeholder="Vi·∫øt tin nh·∫Øn‚Ä¶">
      <button id="sendBtn" title="G·ª≠i" aria-label="G·ª≠i" data-i18n="send.title" data-i18n-attr="title,aria-label">‚û§</button>
    </div>
  </div>
  <button id="chatToggle" class="pig-float" aria-label="M·ªü tr·ª£ l√Ω" data-i18n="chat.open" data-i18n-attr="aria-label">
    <img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt="">
  </button>

<script>
  /* ===== Theme from Settings ===== */
  (function initTheme(){
    const saved = localStorage.getItem('theme');
    document.documentElement.classList.toggle('dark', saved === 'dark');
  })();

  /* ===== I18N ===== */
  const I18N = {
    vi: {
      "page.title":"SmartExpense ‚Äî C·∫£nh b√°o ƒëƒÉng nh·∫≠p b·∫•t th∆∞·ªùng",
      "page.h1":"C·∫£nh b√°o ƒëƒÉng nh·∫≠p b·∫•t th∆∞·ªùng",

      "nav.overview":"T·ªïng quan","nav.list":"Danh s√°ch chi ti√™u","nav.history":"L·ªãch s·ª≠ chi ti√™u",
      "nav.schedule":"L√™n l·ªãch chi ti√™u","nav.types":"Lo·∫°i chi ti√™u","nav.report":"B√°o c√°o",
      "nav.profile":"H·ªì s∆°","nav.settings":"C√†i ƒë·∫∑t","nav.logout":"ƒêƒÉng xu·∫•t",

      "filter.all":"T·∫•t c·∫£","filter.anomaly":"B·∫•t th∆∞·ªùng","filter.ok":"B√¨nh th∆∞·ªùng",
      "ph.search":"T√¨m theo IP, thi·∫øt b·ªã, v·ªã tr√≠‚Ä¶",

      "btn.reviewed":"ƒê√°nh d·∫•u ƒë√£ xem",
      "btn.remoteLogout":"ƒêƒÉng xu·∫•t t·ª´ xa",
      "btn.exportCsv":"Xu·∫•t CSV",

      "count":"{n} phi√™n",

      "detail.title":"Chi ti·∫øt ƒëƒÉng nh·∫≠p",
      "detail.status":"Tr·∫°ng th√°i","detail.device":"Thi·∫øt b·ªã","detail.loc":"V·ªã tr√≠","detail.ip":"IP",
      "detail.time":"Th·ªùi gian","detail.reason":"Nh·∫≠n di·ªán",
      "detail.map":"B·∫£n ƒë·ªì/·∫£nh m√°y ch·ªß (placeholder)",
      "detail.hint":"M·∫πo: B·∫≠t 2FA v√† h·∫°n ch·∫ø ƒëƒÉng nh·∫≠p t·ª´ thi·∫øt b·ªã c√¥ng c·ªông.",

      "badge.trusted":"Tin c·∫≠y","badge.alert":"C·∫£nh b√°o","badge.new":"M·ªõi",

      "act.itsMe":"ƒê√≥ l√† t√¥i","act.logout":"ƒêƒÉng xu·∫•t phi√™n n√†y",
      "act.blockIp":"Ch·∫∑n IP","act.trust":"Tin c·∫≠y thi·∫øt b·ªã","act.forcePw":"Y√™u c·∫ßu ƒë·ªïi m·∫≠t kh·∫©u",

      "chat.title":"Tr·ª£ l√Ω th√¥ng minh","chat.context":"C·∫£nh b√°o ƒëƒÉng nh·∫≠p & b·∫£o m·∫≠t",
      "chat.open":"M·ªü tr·ª£ l√Ω",
      "chat.greet":"Ch√†o b·∫°n! M√¨nh c√≥ th·ªÉ gi√∫p ph√¢n t√≠ch s·ª± ki·ªán ƒëƒÉng nh·∫≠p, g·ª£i √Ω h√†nh ƒë·ªông v√† xu·∫•t b√°o c√°o.",
      "ph.chat":"Vi·∫øt tin nh·∫Øn‚Ä¶","send.title":"G·ª≠i",

      "chat.help.logout":"B·∫°n c√≥ th·ªÉ ch·ªçn nhi·ªÅu d√≤ng r·ªìi b·∫•m ‚ÄúƒêƒÉng xu·∫•t t·ª´ xa‚Äù ƒë·ªÉ k·∫øt th√∫c c√°c phi√™n ƒë√°ng ng·ªù.",
      "chat.help.block":"Trong khung chi ti·∫øt, b·∫•m ‚ÄúCh·∫∑n IP‚Äù ƒë·ªÉ ch·∫∑n IP ƒë√≥ (demo).",
      "chat.help.trust":"B·∫•m ‚ÄúTin c·∫≠y thi·∫øt b·ªã‚Äù n·∫øu x√°c nh·∫≠n thi·∫øt b·ªã l√† c·ªßa b·∫°n.",
      "chat.help.csv":"D√πng n√∫t ‚ÄúXu·∫•t CSV‚Äù ƒë·ªÉ t·∫£i to√†n b·ªô s·ª± ki·ªán.",
      "chat.help.generic":"B·∫°n mu·ªën m√¨nh h∆∞·ªõng d·∫´n thao t√°c n√†o?"
    },
    en: {
      "page.title":"SmartExpense ‚Äî Suspicious sign-in alerts",
      "page.h1":"Suspicious sign-in alerts",

      "nav.overview":"Overview","nav.list":"Expense list","nav.history":"History",
      "nav.schedule":"Budget planner","nav.types":"Categories","nav.report":"Reports",
      "nav.profile":"Profile","nav.settings":"Settings","nav.logout":"Log out",

      "filter.all":"All","filter.anomaly":"Suspicious","filter.ok":"Normal",
      "ph.search":"Search by IP, device, location‚Ä¶",

      "btn.reviewed":"Mark reviewed",
      "btn.remoteLogout":"Remote sign out",
      "btn.exportCsv":"Export CSV",

      "count":"{n} sessions",

      "detail.title":"Sign-in details",
      "detail.status":"Status","detail.device":"Device","detail.loc":"Location","detail.ip":"IP",
      "detail.time":"Time","detail.reason":"Signals",
      "detail.map":"Map/server image (placeholder)",
      "detail.hint":"Tip: Enable 2FA and avoid public devices.",

      "badge.trusted":"Trusted","badge.alert":"Alert","badge.new":"New",

      "act.itsMe":"It‚Äôs me","act.logout":"Sign out this session",
      "act.blockIp":"Block IP","act.trust":"Trust device","act.forcePw":"Force password change",

      "chat.title":"Smart assistant","chat.context":"Sign-in alerts & security",
      "chat.open":"Open assistant",
      "chat.greet":"Hi! I can analyze sign-in events, suggest actions, and export reports.",
      "ph.chat":"Type a message‚Ä¶","send.title":"Send",

      "chat.help.logout":"Select multiple rows then click ‚ÄúRemote sign out‚Äù to end suspicious sessions.",
      "chat.help.block":"In details panel, click ‚ÄúBlock IP‚Äù to block that address (demo).",
      "chat.help.trust":"Click ‚ÄúTrust device‚Äù if it‚Äôs yours.",
      "chat.help.csv":"Use ‚ÄúExport CSV‚Äù to download all events.",
      "chat.help.generic":"What would you like help with?"
    }
  };

  function t(key){
    const lang = localStorage.getItem('lang') || 'vi';
    return (I18N[lang] && I18N[lang][key]) || key;
  }
  function tVar(key, vars={}){
    let s = t(key);
    Object.entries(vars).forEach(([k,v])=>{ s = s.replace(new RegExp(`\\{${k}\\}`,'g'), v); });
    return s;
  }
  function translatePage(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      const val = t(key);
      const attr = el.getAttribute('data-i18n-attr');
      if(attr){
        attr.split(',').forEach(a=>el.setAttribute(a.trim(), val));
      }else if(el.tagName==='INPUT'){
        el.placeholder = val;
      }else{
        el.textContent = val;
      }
    });
    document.title = t('page.title');
    document.documentElement.setAttribute('lang', localStorage.getItem('lang') || 'vi');
  }

  /* ===== Mock events ===== */
  const EVENTS = [
    {id:1, sev:'high', device:'iPhone 15 ‚Äî Safari', city:'H√† N·ªôi', country:'VN', ip:'113.23.40.17', time:'H√¥m nay, 08:15', status:'new', reasons:['Thi·∫øt b·ªã l·∫°','Ch√™nh l·ªách v·ªã tr√≠ l·ªõn'], ok:false},
    {id:2, sev:'med',  device:'Windows ‚Äî Edge',      city:'ƒê√† N·∫µng', country:'VN', ip:'14.162.6.201', time:'H√¥m qua, 22:04', status:'new', reasons:['VPN/Proxy'], ok:false},
    {id:3, sev:'low',  device:'MacBook Pro ‚Äî Chrome 126', city:'H·ªì Ch√≠ Minh', country:'VN', ip:'27.3.145.80', time:'H√¥m qua, 15:31', status:'ok', reasons:['Thi·∫øt b·ªã quen'], ok:true, trusted:true},
    {id:4, sev:'med',  device:'Android ‚Äî Chrome',    city:'Singapore', country:'SG', ip:'103.10.12.2', time:'2 ng√†y tr∆∞·ªõc', status:'reviewed', reasons:['IP b·∫•t th∆∞·ªùng'], ok:false},
    {id:5, sev:'high', device:'Windows ‚Äî Chrome',    city:'California', country:'US', ip:'35.180.114.85', time:'3 ng√†y tr∆∞·ªõc', status:'new', reasons:['ƒêƒÉng nh·∫≠p nhi·ªÅu l·∫ßn th·∫•t b·∫°i'], ok:false},
  ];

  const list   = document.getElementById('list');
  const qInput = document.getElementById('q');
  const countLabel = document.getElementById('countLabel');
  const filters = [...document.querySelectorAll('.chip')];

  let selected = new Set();
  let currentId = null;
  let filterType = 'all';

  function badgeClass(e){ return e.ok ? 'trusted' : (e.sev==='high' ? 'alert' : 'new'); }
  function badgeText(e){ return e.ok ? t('badge.trusted') : (e.sev==='high' ? t('badge.alert') : t('badge.new')); }

  function render(){
    const term = (qInput.value||'').toLowerCase();
    const rows = EVENTS.filter(e=>{
      const okFilter = filterType==='all' ? true : (filterType==='anomaly' ? !e.ok : e.ok);
      const hit = [e.device,e.city,e.country,e.ip].join(' ').toLowerCase().includes(term);
      return okFilter && hit;
    });

    list.innerHTML = '';
    rows.forEach(e=>{
      const row = document.createElement('div');
      row.className = 'row' + (currentId===e.id ? ' active':'' );
      row.dataset.id = e.id;
      row.innerHTML = `
        <input type="checkbox" aria-label="select">
        <div>
          <div class="dev">${e.device}</div>
          <div class="sub">${e.city}, ${e.country} ‚Äî IP ${e.ip}</div>
        </div>
        <div>${e.reasons[0] || ''}</div>
        <div class="time">${e.time}</div>
        <div style="display:flex;align-items:center;gap:8px;justify-content:flex-end">
          <span class="badge ${badgeClass(e)}">${badgeText(e)}</span>
          <span class="sev ${e.sev}" title="${e.sev}"></span>
        </div>
      `;
      const cb = row.querySelector('input[type=checkbox]');
      cb.checked = selected.has(e.id);
      cb.addEventListener('change', ()=>{
        if(cb.checked) selected.add(e.id); else selected.delete(e.id);
        updateBulkButtons();
      });
      row.addEventListener('click', (ev)=>{
        if(ev.target.tagName==='INPUT') return;
        currentId = e.id; renderDetail(e);
        [...list.children].forEach(r=>r.classList.toggle('active', +r.dataset.id===e.id));
      });
      list.appendChild(row);
    });

    countLabel.textContent = tVar('count',{n: rows.length});
    updateBulkButtons();
    if(rows.length && !currentId){ currentId = rows[0].id; renderDetail(rows[0]); }
    if(!rows.length){ document.getElementById('detail').innerHTML = `<div class="sub">${t('count').replace('{n}','0')}</div>`; }
  }

  function renderDetail(e){
    document.getElementById('detail').innerHTML = `
      <div class="kv"><div>${t('detail.status')}</div><div>
        <span class="badge ${badgeClass(e)}">${badgeText(e)}</span>
      </div></div>
      <div class="kv"><div>${t('detail.device')}</div><div class="dev">${e.device}</div></div>
      <div class="kv"><div>${t('detail.loc')}</div><div>${e.city}, ${e.country}</div></div>
      <div class="kv"><div>${t('detail.ip')}</div><div class="mono">${e.ip}</div></div>
      <div class="kv"><div>${t('detail.time')}</div><div>${e.time}</div></div>
      <div class="kv"><div>${t('detail.reason')}</div><div>${(e.reasons||[]).join('; ')}</div></div>
      <div class="map">${t('detail.map')}</div>
      <div class="actions">
        <button class="btn btn-primary" id="itsMe">${t('act.itsMe')}</button>
        <button class="btn btn-danger" id="logout">${t('act.logout')}</button>
        <button class="btn btn-ghost" id="blockIp">${t('act.blockIp')}</button>
        <button class="btn btn-soft" id="trustDevice">${t('act.trust')}</button>
        <button class="btn btn-soft" id="forceChangePw">${t('act.forcePw')}</button>
      </div>
      <div class="hint">${t('detail.hint')}</div>
    `;

    document.getElementById('itsMe').onclick = ()=>{ e.ok=true; e.status='reviewed'; alert(badgeText(e)); render(); };
    document.getElementById('logout').onclick = ()=>{ alert(t('btn.remoteLogout')); };
    document.getElementById('blockIp').onclick = ()=>{ alert(t('act.blockIp')+': '+e.ip); };
    document.getElementById('trustDevice').onclick = ()=>{ e.ok=true; e.trusted=true; alert(t('badge.trusted')); render(); };
    document.getElementById('forceChangePw').onclick = ()=>{ alert(t('act.forcePw')); };
  }

  function updateBulkButtons(){
    const any = selected.size>0;
    document.getElementById('markReviewed').disabled = !any;
    document.getElementById('logoutSelected').disabled = !any;
  }

  document.getElementById('markReviewed').onclick = ()=>{
    EVENTS.forEach(e=>{ if(selected.has(e.id)) e.status='reviewed'; });
    alert(t('btn.reviewed')); selected.clear(); render();
  };
  document.getElementById('logoutSelected').onclick = ()=>{
    alert(t('btn.remoteLogout')); selected.clear(); render();
  };

  document.getElementById('exportCsv').onclick = ()=>{
    const header = 'id,severity,device,city,country,ip,time,status,reasons\n';
    const lines = EVENTS.map(e=>[
      e.id,e.sev,`"${e.device}"`,e.city,e.country,e.ip,`"${e.time}"`,e.status,`"${(e.reasons||[]).join('|')}"`].join(','));
    const blob = new Blob([header+lines.join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='login-events.csv'; a.click();
    URL.revokeObjectURL(url);
  };

  filters.forEach(b=>{
    b.onclick = ()=>{
      filters.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      filterType = b.dataset.filter;
      selected.clear();
      currentId = null; render();
    };
  });
  qInput.oninput = ()=>{ currentId = null; render(); };

  /* ===== Chatbox ===== */
  const chatToggle=document.getElementById('chatToggle');
  const chatbox=document.getElementById('chatbox');
  const chatBody=document.getElementById('chatBody');
  const chatInput=document.getElementById('chatInput');
  const sendBtn=document.getElementById('sendBtn');
  let greeted=false;

  function addMsg(text, who='bot'){
    const wrap=document.createElement('div'); wrap.className='msg '+who;
    const av=document.createElement('div'); av.className='avatar-s'; av.textContent=(who==='bot'?'üê∑':'üë§');
    const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
    if(who==='bot'){wrap.append(av,b);} else {wrap.append(b,av);}
    chatBody.appendChild(wrap); chatBody.scrollTop=chatBody.scrollHeight;
  }
  function openChat(){
    chatbox.classList.add('open'); chatbox.setAttribute('aria-hidden','false');
    if(!greeted){ addMsg(t('chat.greet')); greeted=true; }
    setTimeout(()=>chatInput.focus(),100);
  }
  function closeChat(){ chatbox.classList.remove('open'); chatbox.setAttribute('aria-hidden','true'); }
  chatToggle.onclick = ()=> chatbox.classList.contains('open') ? closeChat() : openChat();

  function handleSend(){
    const txt=chatInput.value.trim(); if(!txt) return;
    addMsg(txt,'user'); chatInput.value='';
    const q = txt.toLowerCase();
    const lang = localStorage.getItem('lang') || 'vi';
    const hitLogout = (lang==='en') ? q.includes('logout') || q.includes('sign out') : q.includes('ƒëƒÉng xu·∫•t');
    const hitBlock  = (lang==='en') ? q.includes('block') && q.includes('ip') : q.includes('ch·∫∑n ip');
    const hitTrust  = (lang==='en') ? q.includes('trust') : q.includes('tin c·∫≠y');
    const hitCsv    = (lang==='en') ? q.includes('csv') || q.includes('export') : (q.includes('csv')||q.includes('xu·∫•t'));
    if(hitLogout) addMsg(t('chat.help.logout'));
    else if(hitBlock) addMsg(t('chat.help.block'));
    else if(hitTrust) addMsg(t('chat.help.trust'));
    else if(hitCsv) addMsg(t('chat.help.csv'));
    else addMsg(t('chat.help.generic'));
  }
  sendBtn.onclick = handleSend;
  chatInput.onkeydown = e=>{ if(e.key==='Enter') handleSend(); };

  /* ===== Init lang & render ===== */
  (function init(){
    const savedLang = localStorage.getItem('lang') || 'vi';
    document.documentElement.setAttribute('lang', savedLang);
    translatePage();
    render();
  })();
</script>
</body>
</html>
