<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title data-i18n="page.title">SmartExpense ‚Äî Qu·∫£n l√Ω thi·∫øt b·ªã</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eaf3f9; --card:#fff; --text:#0f172a; --muted:#64748b;
    --border:#e5e7eb; --blue:#2563eb; --green:#22c55e;
    --yellow:#f59e0b; --red:#ef4444;
    --radius:14px; --shadow:0 10px 26px rgba(15,23,42,.06);
    --soft:#f8fafc; --chip:#fff; --chip-hover:rgba(37,99,235,.08);
    --chat-bg:#f4fbff;
  }
  html.dark{
    --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#9aa4b2;
    --border:#1f2a44; --blue:#3b82f6; --green:#22c55e;
    --yellow:#f59e0b; --red:#f87171;
    --soft:#0e1928; --chip:#0f172a; --chip-hover:rgba(59,130,246,.15);
    --chat-bg:#071520;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:grid;grid-template-columns:260px 1fr;min-height:100vh;
  }
  input,button{font:inherit;color:inherit}

  /* ===== Sidebar ===== */
  .sidebar{background:var(--card);border-right:1px solid var(--border);padding:18px 14px}
  .brand{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .brand .logo{width:40px;height:40px;border-radius:10px;overflow:hidden;background:#ffe8e0;display:grid;place-items:center;box-shadow:var(--shadow)}
  .brand .logo img{width:100%;height:100%;object-fit:cover}
  .brand b{font-size:18px}
  .nav{display:flex;flex-direction:column;gap:6px}
  .nav a{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;color:var(--text);font-weight:700;text-decoration:none}
  .nav a:hover{background:var(--chip-hover)}
  .nav a.active{background:var(--blue);color:#fff}

  /* ===== Main ===== */
  .main{padding:22px 24px 40px}
  .wrap{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:18px;max-width:1200px}
  .header{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .title{font-size:24px;font-weight:800;margin:0}
  .tools{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chip{height:34px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-weight:800;padding:0 12px;cursor:pointer;color:var(--text)}
  .chip.active{background:var(--text);color:var(--card);border-color:var(--text)}
  .search{display:flex;gap:8px}
  .input{height:38px;border:1px solid var(--border);border-radius:999px;background:var(--soft);display:flex;align-items:center;padding:0 12px}
  .input input{border:0;outline:none;background:transparent;height:100%;color:var(--text)}

  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:12px}

  /* List */
  .bar{display:flex;gap:10px;align-items:center;margin:6px 0}
  .btn{height:38px;border-radius:10px;padding:0 12px;font-weight:800;cursor:pointer}
  .btn-ghost{background:var(--card);border:1px solid var(--border);color:var(--text)}
  .btn-primary{background:var(--blue);color:#fff;border:0}
  .btn-danger{background:var(--card);border:1px solid #fecaca;color:#991b1b}
  .btn-soft{background:var(--soft);border:1px solid var(--border);color:var(--text)}
  .count{color:var(--muted);font-size:14px;margin-left:auto}

  .list{display:grid;gap:10px}
  .row{
    display:grid;grid-template-columns:28px 1fr 120px 80px 120px;gap:10px;
    align-items:center;border:1px solid var(--border);background:var(--card);border-radius:12px;padding:10px;
  }
  .row.active{outline:2px solid #9aa5b1}
  .dev{font-weight:800}
  .sub{color:var(--muted)}
  .time{text-align:right;color:var(--muted)}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}
  .badge.ok{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
  .badge.blocked{background:#fff1f2;border-color:#fecdd3;color:#b91c1c}
  .badge.active{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}
  .badge.this{background:#f5f3ff;border-color:#ddd6fe;color:#6d28d9}

  /* Detail panel */
  .panel{border-left:2px solid var(--border);padding-left:12px}
  .panel h3{margin:4px 0 10px;font-size:18px;font-weight:800}
  .device-head{display:grid;grid-template-columns:64px 1fr;gap:10px;align-items:center}
  .avatar{width:64px;height:64px;border-radius:16px;background:#fff2e5;display:grid;place-items:center;font-size:32px}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;font-size:14px;margin:6px 0}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .hint{color:var(--muted);font-size:13px;margin-top:6px}
  .sessions{margin-top:12px;border-top:1px solid var(--border);padding-top:10px}
  .sessions .srow{display:grid;grid-template-columns:1fr 120px 120px;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed var(--border)}
  .sessions .srow:last-child{border-bottom:0}

  /* Chatbox */
  .pig-float{position:fixed;right:26px;bottom:26px;width:76px;height:76px;border-radius:18px;background:#ffe8e0;display:grid;place-items:center;box-shadow:var(--shadow);z-index:30;border:0;cursor:pointer}
  .pig-float img{width:64px;height:64px}
  .chatbox{position:fixed;right:26px;bottom:112px;width:340px;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;display:none;z-index:40;grid-template-rows:56px 1fr 60px}
  .chatbox.open{display:grid}
  .chat-head{background:#1da1c9;color:#fff;display:flex;align-items:center;gap:10px;padding:10px 12px;font-weight:800}
  .chat-head img{width:28px;height:28px;border-radius:6px;background:#ffe8e0}
  .chat-title{line-height:1.2}
  .chat-body{background:var(--chat-bg);overflow:auto;padding:10px;max-height:380px}
  .msg{display:flex;align-items:flex-end;margin:8px 0;gap:8px}
  .bubble{max-width:78%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:var(--card);font-size:14px;color:var(--text)}
  .msg.user{justify-content:flex-end}
  .msg.user .bubble{background:var(--blue);border:none;color:#fff}
  .avatar-s{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;background:#ffe8e0;flex:0 0 26px;font-size:14px}
  .chat-input{background:var(--card);border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;padding:8px}
  #chatInput{flex:1;height:40px;border:1px solid var(--border);border-radius:999px;padding:0 12px;outline:none;background:var(--card);color:var(--text)}
  #chatInput:focus{box-shadow:none;border-color:var(--border)}
  #sendBtn{width:38px;height:38px;border-radius:999px;border:0;background:var(--blue);color:#fff;display:grid;place-items:center;cursor:pointer}

  @media (max-width:1100px){
    body{grid-template-columns:1fr}
    .sidebar{position:sticky;top:0;z-index:20}
    .wrap{max-width:none}
    .grid{grid-template-columns:1fr}
    .panel{border-left:0;border-top:2px solid var(--border);padding-left:0;padding-top:12px}
    .chatbox{right:16px;bottom:96px;width:min(92vw,360px)}
    .pig-float{right:16px}
  }
</style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"><img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt=""></div>
      <b>SmartExpense</b>
    </div>
    <nav class="nav">
      <a href="trangchu.html">üè† <span data-i18n="nav.overview">T·ªïng quan</span></a>
      <a href="danhsachchitieu.html">üßæ <span data-i18n="nav.list">Danh s√°ch chi ti√™u</span></a>
      <a href="lichsuchitieu.html">üïò <span data-i18n="nav.history">L·ªãch s·ª≠ chi ti√™u</span></a>
      <a href="lenlichchitieu.html">üìÖ <span data-i18n="nav.schedule">L√™n l·ªãch chi ti√™u</span></a>
      <a href="loaichitieu.html">üè∑Ô∏è <span data-i18n="nav.types">Lo·∫°i chi ti√™u</span></a>
      <a href="baocao.html">üìä <span data-i18n="nav.report">B√°o c√°o</span></a>
      <a href="hoso.html">üë§ <span data-i18n="nav.profile">H·ªì s∆°</span></a>
      <a href="caidat.html" class="active">‚öôÔ∏è <span data-i18n="nav.settings">C√†i ƒë·∫∑t</span></a>
      <a href="login.html">‚Ü™Ô∏è <span data-i18n="nav.logout">ƒêƒÉng xu·∫•t</span></a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="wrap">
      <div class="header">
        <h1 class="title" data-i18n="page.h1">Qu·∫£n l√Ω thi·∫øt b·ªã</h1>
        <div class="tools">
          <button class="chip active" data-filter="all" data-i18n="filter.all">T·∫•t c·∫£</button>
          <button class="chip" data-filter="trusted" data-i18n="filter.trusted">Tin c·∫≠y</button>
          <button class="chip" data-filter="active" data-i18n="filter.active">ƒêang ho·∫°t ƒë·ªông</button>
          <button class="chip" data-filter="blocked" data-i18n="filter.blocked">B·ªã ch·∫∑n</button>
          <div class="search">
            <div class="input"><input id="q" placeholder="T√¨m theo t√™n, h·ªá ƒëi·ªÅu h√†nh, IP‚Ä¶" data-i18n="ph.search"></div>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT -->
        <section>
          <div class="bar">
            <button id="logoutSelected" class="btn btn-danger" disabled data-i18n="bulk.logout">ƒêƒÉng xu·∫•t kh·ªèi thi·∫øt b·ªã</button>
            <button id="trustSelected" class="btn btn-soft" disabled data-i18n="bulk.trust">ƒê·∫∑t tin c·∫≠y</button>
            <button id="blockSelected" class="btn btn-ghost" disabled data-i18n="bulk.block">Ch·∫∑n</button>
            <button id="exportCsv" class="btn btn-soft" data-i18n="bulk.export">Xu·∫•t CSV</button>
            <div class="count" id="countLabel"></div>
          </div>

          <div id="list" class="list"></div>
        </section>

        <!-- RIGHT -->
        <aside class="panel">
          <h3 data-i18n="detail.title">Chi ti·∫øt thi·∫øt b·ªã</h3>
          <div id="detail">
            <div class="sub" data-i18n="detail.empty">Ch·ªçn m·ªôt thi·∫øt b·ªã ·ªü danh s√°ch b√™n tr√°i ƒë·ªÉ xem chi ti·∫øt.</div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <!-- Chatbox -->
  <div id="chatbox" class="chatbox" aria-hidden="true">
    <div class="chat-head">
      <img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt="">
      <div>
        <div class="chat-title" data-i18n="chat.title">Tr·ª£ l√Ω th√¥ng minh</div>
        <div style="font-size:12px;opacity:.95" data-i18n="chat.sub">Qu·∫£n l√Ω thi·∫øt b·ªã & phi√™n ƒëƒÉng nh·∫≠p</div>
      </div>
    </div>
    <div id="chatBody" class="chat-body"></div>
    <div class="chat-input">
      <input id="chatInput" type="text" placeholder="Vi·∫øt tin nh·∫Øn‚Ä¶" data-i18n="ph.chat">
      <button id="sendBtn" title="G·ª≠i" aria-label="G·ª≠i" data-i18n="send.title" data-i18n-attr="title,aria-label">‚û§</button>
    </div>
  </div>
  <button id="chatToggle" class="pig-float" aria-label="M·ªü tr·ª£ l√Ω" data-i18n="chat.open" data-i18n-attr="aria-label">
    <img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt="">
  </button>

<script>
  /* ===== Theme & Language ===== */
  function getLang(){let l=localStorage.getItem('lang');if(!l){l=(navigator.language||'vi').toLowerCase().startsWith('vi')?'vi':'en';localStorage.setItem('lang',l);}return l;}
  function setLang(l){localStorage.setItem('lang',l);document.documentElement.setAttribute('lang',l);translatePage();render(); if(currentId){renderDetail(DEVICES.find(x=>x.id===currentId));}}
  function getTheme(){return localStorage.getItem('theme')||'light'}
  function setTheme(t){localStorage.setItem('theme',t);document.documentElement.classList.toggle('dark',t==='dark');}

  const I18N={
    vi:{
      "page.title":"SmartExpense ‚Äî Qu·∫£n l√Ω thi·∫øt b·ªã","page.h1":"Qu·∫£n l√Ω thi·∫øt b·ªã",
      "nav.overview":"T·ªïng quan","nav.list":"Danh s√°ch chi ti√™u","nav.history":"L·ªãch s·ª≠ chi ti√™u","nav.schedule":"L√™n l·ªãch chi ti√™u","nav.types":"Lo·∫°i chi ti√™u","nav.report":"B√°o c√°o","nav.profile":"H·ªì s∆°","nav.settings":"C√†i ƒë·∫∑t","nav.logout":"ƒêƒÉng xu·∫•t",
      "filter.all":"T·∫•t c·∫£","filter.trusted":"Tin c·∫≠y","filter.active":"ƒêang ho·∫°t ƒë·ªông","filter.blocked":"B·ªã ch·∫∑n",
      "ph.search":"T√¨m theo t√™n, h·ªá ƒëi·ªÅu h√†nh, IP‚Ä¶",
      "bulk.logout":"ƒêƒÉng xu·∫•t kh·ªèi thi·∫øt b·ªã","bulk.trust":"ƒê·∫∑t tin c·∫≠y","bulk.block":"Ch·∫∑n","bulk.export":"Xu·∫•t CSV",
      "detail.title":"Chi ti·∫øt thi·∫øt b·ªã","detail.empty":"Ch·ªçn m·ªôt thi·∫øt b·ªã ·ªü danh s√°ch b√™n tr√°i ƒë·ªÉ xem chi ti·∫øt.",
      "badge.sessions":"{n} phi√™n","badge.this":"Thi·∫øt b·ªã n√†y","badge.trusted":"Tin c·∫≠y","badge.blocked":"B·ªã ch·∫∑n",
      "kv.status":"Tr·∫°ng th√°i","kv.fp":"Fingerprint","kv.loc":"V·ªã tr√≠","kv.ip":"IP hi·ªán t·∫°i","kv.last":"Ho·∫°t ƒë·ªông g·∫ßn nh·∫•t",
      "btn.logoutAll":"ƒêƒÉng xu·∫•t m·ªçi phi√™n","btn.block":"Ch·∫∑n thi·∫øt b·ªã","btn.unblock":"B·ªè ch·∫∑n","btn.trust":"ƒê·∫∑t tin c·∫≠y","btn.untrust":"B·ªè tin c·∫≠y","btn.rename":"ƒê·ªïi t√™n","btn.copyId":"Sao ch√©p ID",
      "sessions.title":"Phi√™n ho·∫°t ƒë·ªông","sessions.prev":"Tr∆∞·ªõc ƒë√≥",
      "hint":"M·∫πo: H√£y ch·∫∑n thi·∫øt b·ªã l·∫°, ƒë·∫∑t tin c·∫≠y cho thi·∫øt b·ªã c√° nh√¢n, v√† b·∫≠t x√°c th·ª±c hai l·ªõp.",
      "count.devices":"{n} thi·∫øt b·ªã",
      "alert.logoutMany":"ƒê√£ g·ª≠i y√™u c·∫ßu ƒëƒÉng xu·∫•t {n} thi·∫øt b·ªã (demo).",
      "alert.trustMany":"ƒê√£ ƒë·∫∑t tin c·∫≠y (demo).","alert.blockMany":"ƒê√£ ch·∫∑n thi·∫øt b·ªã (demo).",
      "alert.enterPhone":"Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i tr∆∞·ªõc.",
      "prompt.rename":"T√™n m·ªõi cho thi·∫øt b·ªã",
      "alert.copiedFp":"ƒê√£ sao ch√©p Fingerprint",
      "chat.title":"Tr·ª£ l√Ω th√¥ng minh","chat.sub":"Qu·∫£n l√Ω thi·∫øt b·ªã & phi√™n ƒëƒÉng nh·∫≠p","chat.open":"M·ªü tr·ª£ l√Ω",
      "chat.greet":"Ch√†o b·∫°n! M√¨nh c√≥ th·ªÉ gi√∫p ch·∫∑n/ƒë·∫∑t tin c·∫≠y thi·∫øt b·ªã, ƒëƒÉng xu·∫•t phi√™n t·ª´ xa v√† xu·∫•t CSV.",
      "ph.chat":"Vi·∫øt tin nh·∫Øn‚Ä¶","send.title":"G·ª≠i",
      "chat.help.block":"Ch·ªçn thi·∫øt b·ªã r·ªìi b·∫•m ‚ÄúCh·∫∑n‚Äù (ho·∫∑c trong chi ti·∫øt b·∫•m ‚ÄúCh·∫∑n thi·∫øt b·ªã‚Äù).",
      "chat.help.trust":"Ch·ªçn thi·∫øt b·ªã ‚Üí ‚Äúƒê·∫∑t tin c·∫≠y‚Äù, ho·∫∑c b·∫≠t trong khung chi ti·∫øt.",
      "chat.help.logout":"D√πng ‚ÄúƒêƒÉng xu·∫•t kh·ªèi thi·∫øt b·ªã‚Äù ƒë·ªÉ k·∫øt th√∫c c√°c phi√™n ƒëang m·ªü.",
      "chat.help.csv":"B·∫•m ‚ÄúXu·∫•t CSV‚Äù ·ªü thanh c√¥ng c·ª• ƒë·ªÉ t·∫£i danh s√°ch thi·∫øt b·ªã.",
      "chat.help.ask":"B·∫°n mu·ªën thao t√°c g√¨ v·ªõi thi·∫øt b·ªã?"
    },
    en:{
      "page.title":"SmartExpense ‚Äî Device management","page.h1":"Device management",
      "nav.overview":"Overview","nav.list":"Expense list","nav.history":"History","nav.schedule":"Budget planner","nav.types":"Categories","nav.report":"Reports","nav.profile":"Profile","nav.settings":"Settings","nav.logout":"Log out",
      "filter.all":"All","filter.trusted":"Trusted","filter.active":"Active","filter.blocked":"Blocked",
      "ph.search":"Search by name, OS, IP‚Ä¶",
      "bulk.logout":"Log out from devices","bulk.trust":"Mark trusted","bulk.block":"Block","bulk.export":"Export CSV",
      "detail.title":"Device details","detail.empty":"Select a device from the list to view details.",
      "badge.sessions":"{n} sessions","badge.this":"This device","badge.trusted":"Trusted","badge.blocked":"Blocked",
      "kv.status":"Status","kv.fp":"Fingerprint","kv.loc":"Location","kv.ip":"Current IP","kv.last":"Last activity",
      "btn.logoutAll":"Log out all sessions","btn.block":"Block device","btn.unblock":"Unblock","btn.trust":"Mark trusted","btn.untrust":"Untrust","btn.rename":"Rename","btn.copyId":"Copy ID",
      "sessions.title":"Active sessions","sessions.prev":"Previous",
      "hint":"Tip: Block unfamiliar devices, mark your own devices as trusted, and enable 2FA.",
      "count.devices":"{n} devices",
      "alert.logoutMany":"Requested logout for {n} device(s) (demo).",
      "alert.trustMany":"Trusted set (demo).","alert.blockMany":"Device(s) blocked (demo).",
      "alert.enterPhone":"Enter phone first.",
      "prompt.rename":"New device name",
      "alert.copiedFp":"Fingerprint copied",
      "chat.title":"Smart assistant","chat.sub":"Device & session helper","chat.open":"Open assistant",
      "chat.greet":"Hi! I can help block/trust devices, log out sessions remotely, and export CSV.",
      "ph.chat":"Type a message‚Ä¶","send.title":"Send",
      "chat.help.block":"Select a device then click ‚ÄúBlock‚Äù (or ‚ÄúBlock device‚Äù in the details panel).",
      "chat.help.trust":"Select a device ‚Üí ‚ÄúMark trusted‚Äù, or toggle in the details panel.",
      "chat.help.logout":"Use ‚ÄúLog out from devices‚Äù to terminate active sessions.",
      "chat.help.csv":"Click ‚ÄúExport CSV‚Äù in the toolbar to download the list.",
      "chat.help.ask":"What would you like to do with a device?"
    }
  };

  function t(key, vars={}){
    const l=getLang();
    let s=(I18N[l]&&I18N[l][key])||key;
    Object.entries(vars).forEach(([k,v])=>{ s=s.replace(new RegExp(`\\{${k}\\}`,'g'), v); });
    return s;
  }

  // Ch·ªâ d·ªãch thu·ªôc t√≠nh n·∫øu c√≥ data-i18n-attr, kh√¥ng ghi ƒë√® icon/·∫£nh
  function translatePage(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key=el.getAttribute('data-i18n');
      const val=t(key);
      if(el.hasAttribute('data-i18n-attr')){
        el.getAttribute('data-i18n-attr').split(',').forEach(a=>el.setAttribute(a.trim(), val));
      }else if(el.tagName==='INPUT' || el.tagName==='TEXTAREA'){
        el.placeholder = val;
      }else if(el.children.length===0){
        el.textContent = val;
      }
    });
    const titleEl=document.querySelector('title[data-i18n="page.title"], title');
    if(titleEl) titleEl.textContent=t('page.title');
  }

  // Bootstrap + l·∫Øng nghe cross-tab
  (function(){ setTheme(getTheme()); document.documentElement.setAttribute('lang',getLang()); translatePage(); })();
  window.addEventListener('storage', (e)=>{
    if(e.key==='theme' && e.newValue){ setTheme(e.newValue); }
    if(e.key==='lang'  && e.newValue){ setLang(e.newValue); }
  });

  /* ===== Demo data ===== */
  const DEVICES = [
    {id:1, name:'iPhone 15',         platform:'iOS',      browser:'Safari',  city:'H√† N·ªôi',       country:'VN', ip:'113.23.40.17', last:'H√¥m nay, 09:10', sessions:2, trusted:false, blocked:false, current:false, emoji:'üì±', fp:'DF-AB12-9C31'},
    {id:2, name:'MacBook Pro',       platform:'macOS',    browser:'Chrome',  city:'H·ªì Ch√≠ Minh',  country:'VN', ip:'27.3.145.80',   last:'H√¥m nay, 08:02', sessions:3, trusted:true,  blocked:false, current:true,  emoji:'üíª', fp:'DF-8F11-1A7C'},
    {id:3, name:'Windows PC',        platform:'Windows',  browser:'Edge',    city:'ƒê√† N·∫µng',      country:'VN', ip:'14.162.6.201',  last:'H√¥m qua, 22:03', sessions:1, trusted:false, blocked:false, current:false, emoji:'üñ•Ô∏è', fp:'DF-0A44-7B2E'},
    {id:4, name:'Android Tablet',    platform:'Android',  browser:'Chrome',  city:'Singapore',    country:'SG', ip:'103.10.12.2',   last:'2 ng√†y tr∆∞·ªõc',   sessions:1, trusted:false, blocked:true,  current:false, emoji:'üì≤', fp:'DF-9C8A-0F10'},
    {id:5, name:'Office Laptop',     platform:'Windows',  browser:'Chrome',  city:'California',   country:'US', ip:'35.180.114.85', last:'3 ng√†y tr∆∞·ªõc',   sessions:1, trusted:true,  blocked:false, current:false, emoji:'üíº', fp:'DF-7777-AAAA'}
  ];

  const list = document.getElementById('list');
  const q = document.getElementById('q');
  const filters = [...document.querySelectorAll('.chip')];
  const countLabel = document.getElementById('countLabel');

  let filterType='all';
  let selected = new Set();
  let currentId = null;

  function render(){
    const term=(q.value||'').toLowerCase();
    const rows = DEVICES.filter(d=>{
      const ok =
        filterType==='all' ? true :
        filterType==='trusted' ? d.trusted :
        filterType==='active' ? d.sessions>0 && !d.blocked :
        filterType==='blocked' ? d.blocked : true;
      const hit = [d.name,d.platform,d.browser,d.city,d.country,d.ip].join(' ').toLowerCase().includes(term);
      return ok && hit;
    });

    list.innerHTML='';
    rows.forEach(d=>{
      const row=document.createElement('div');
      row.className='row'+(currentId===d.id?' active':'');
      row.dataset.id=d.id;
      row.innerHTML=`
        <input type="checkbox" aria-label="${d.name}">
        <div>
          <div class="dev">${d.emoji} ${d.name} ‚Äî ${d.platform} ¬∑ ${d.browser}</div>
          <div class="sub">${d.city}, ${d.country} ‚Äî IP ${d.ip}</div>
        </div>
        <div><span class="badge ${d.sessions>0?'active':''}">${t('badge.sessions',{n:d.sessions})}</span></div>
        <div class="time">${d.last}</div>
        <div style="display:flex;gap:6px;justify-content:flex-end">
          ${d.current?`<span class="badge this">${t('badge.this')}</span>`:''}
          ${d.trusted?`<span class="badge ok">${t('badge.trusted')}</span>`:''}
          ${d.blocked?`<span class="badge blocked">${t('badge.blocked')}</span>`:''}
        </div>
      `;
      const cb=row.querySelector('input[type=checkbox]');
      cb.checked=selected.has(d.id);
      cb.addEventListener('change', ()=>{ if(cb.checked) selected.add(d.id); else selected.delete(d.id); updateBulk(); });
      row.addEventListener('click', (ev)=>{ if(ev.target.tagName==='INPUT') return; currentId=d.id; renderDetail(d); [...list.children].forEach(r=>r.classList.toggle('active',+r.dataset.id===d.id)); });
      list.appendChild(row);
    });

    countLabel.textContent=t('count.devices',{n:rows.length});
    updateBulk();

    if(rows.length && !currentId){ currentId=rows[0].id; renderDetail(rows[0]); }
    if(!rows.length){ document.getElementById('detail').innerHTML=`<div class="sub">${t('detail.empty')}</div>`; }
  }

  function renderDetail(d){
    document.getElementById('detail').innerHTML=`
      <div class="device-head">
        <div class="avatar">${d.emoji}</div>
        <div>
          <div style="font-weight:800;font-size:18px">${d.name}</div>
          <div class="sub">${d.platform} ¬∑ ${d.browser}</div>
        </div>
      </div>

      <div class="kv"><div>${t('kv.status')}</div>
        <div>
          ${d.current?`<span class="badge this">${t('badge.this')}</span> `:''}
          ${d.trusted?`<span class="badge ok">${t('badge.trusted')}</span> `:''}
          ${d.blocked?`<span class="badge blocked">${t('badge.blocked')}</span>`:''}
        </div>
      </div>
      <div class="kv"><div>${t('kv.fp')}</div><div class="mono">${d.fp}</div></div>
      <div class="kv"><div>${t('kv.loc')}</div><div>${d.city}, ${d.country}</div></div>
      <div class="kv"><div>${t('kv.ip')}</div><div>${d.ip}</div></div>
      <div class="kv"><div>${t('kv.last')}</div><div>${d.last}</div></div>

      <div class="actions">
        <button class="btn btn-primary" id="logoutAll">${t('btn.logoutAll')}</button>
        <button class="btn ${d.blocked?'btn-soft':'btn-ghost'}" id="toggleBlock">${d.blocked?t('btn.unblock'):t('btn.block')}</button>
        <button class="btn btn-soft" id="toggleTrust">${d.trusted?t('btn.untrust'):t('btn.trust')}</button>
        <button class="btn btn-ghost" id="renameDev">${t('btn.rename')}</button>
        <button class="btn btn-soft" id="copyId">${t('btn.copyId')}</button>
      </div>

      <div class="sessions">
        <div style="font-weight:800;margin-bottom:6px">${t('sessions.title')}</div>
        ${Array.from({length:Math.max(1,d.sessions)}).map((_,i)=>`
          <div class="srow">
            <div>${d.browser} ¬∑ ${d.platform}</div>
            <div class="sub">${d.city}, ${d.country}</div>
            <div class="time">${i===0?d.last:t('sessions.prev')}</div>
          </div>
        `).join('')}
      </div>

      <div class="hint">${t('hint')}</div>
    `;

    document.getElementById('logoutAll').onclick = ()=>{ alert(t('alert.logoutMany',{n:d.sessions||0})); };
    document.getElementById('toggleBlock').onclick = ()=>{ d.blocked=!d.blocked; render(); };
    document.getElementById('toggleTrust').onclick = ()=>{ d.trusted=!d.trusted; render(); };
    document.getElementById('renameDev').onclick = ()=>{ const nn=prompt(t('prompt.rename'), d.name)||d.name; d.name=nn; render(); };
    document.getElementById('copyId').onclick = ()=>{ navigator.clipboard.writeText(d.fp); alert(t('alert.copiedFp')); };
  }

  function updateBulk(){
    const any=selected.size>0;
    document.getElementById('logoutSelected').disabled=!any;
    document.getElementById('trustSelected').disabled=!any;
    document.getElementById('blockSelected').disabled=!any;
  }

  // Bulk handlers
  document.getElementById('logoutSelected').onclick = ()=>{ alert(t('alert.logoutMany',{n:selected.size})); selected.clear(); render(); };
  document.getElementById('trustSelected').onclick = ()=>{ DEVICES.forEach(d=>{ if(selected.has(d.id)) d.trusted=true; }); alert(t('alert.trustMany')); selected.clear(); render(); };
  document.getElementById('blockSelected').onclick = ()=>{ DEVICES.forEach(d=>{ if(selected.has(d.id)) d.blocked=true; }); alert(t('alert.blockMany')); selected.clear(); render(); };

  // Export CSV
  document.getElementById('exportCsv').onclick = ()=>{
    const header='id,name,platform,browser,city,country,ip,last,sessions,trusted,blocked,current,fingerprint\n';
    const lines=DEVICES.map(d=>[d.id,`"${d.name}"`,d.platform,d.browser,d.city,d.country,d.ip,`"${d.last}"`,d.sessions,d.trusted,d.blocked,d.current,d.fp].join(','));
    const blob=new Blob([header+lines.join('\n')],{type:'text/csv'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='devices.csv'; a.click(); URL.revokeObjectURL(url);
  };

  // Filters & search
  const filterClick=(b)=>{ filters.forEach(x=>x.classList.remove('active')); b.classList.add('active'); filterType=b.dataset.filter; currentId=null; render(); };
  filters.forEach(b=>{ b.onclick=()=>filterClick(b); });
  q.oninput=()=>{ currentId=null; render(); };

  // First render
  render();

  /* ===== Chatbox (i18n) ===== */
  const chatToggle=document.getElementById('chatToggle');
  const chatbox=document.getElementById('chatbox');
  const chatBody=document.getElementById('chatBody');
  const chatInput=document.getElementById('chatInput');
  const sendBtn=document.getElementById('sendBtn');
  let greeted=false;

  function addMsg(text, who='bot'){
    const wrap=document.createElement('div'); wrap.className='msg '+who;
    const av=document.createElement('div'); av.className='avatar-s'; av.textContent=(who==='bot'?'üê∑':'üë§');
    const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
    if(who==='bot'){wrap.append(av,b);} else {wrap.append(b,av);}
    chatBody.appendChild(wrap); chatBody.scrollTop=chatBody.scrollHeight;
  }
  function greetText(){return t('chat.greet');}
  function openChat(){ chatbox.classList.add('open'); chatbox.setAttribute('aria-hidden','false'); if(!greeted){ addMsg(greetText()); greeted=true; } setTimeout(()=>chatInput.focus(),100); }
  function closeChat(){ chatbox.classList.remove('open'); chatbox.setAttribute('aria-hidden','true'); }
  chatToggle.onclick=()=> chatbox.classList.contains('open') ? closeChat() : openChat();

  function handleSend(){
    const txt=chatInput.value.trim(); if(!txt) return;
    addMsg(txt,'user'); chatInput.value='';
    const k=txt.toLowerCase();
    if(k.includes('ch·∫∑n')||k.includes('block')) addMsg(t('chat.help.block'));
    else if(k.includes('tin c·∫≠y')||k.includes('trust')) addMsg(t('chat.help.trust'));
    else if(k.includes('ƒëƒÉng xu·∫•t')||k.includes('logout')) addMsg(t('chat.help.logout'));
    else if(k.includes('csv')) addMsg(t('chat.help.csv'));
    else addMsg(t('chat.help.ask'));
  }
  sendBtn.onclick=handleSend;
  chatInput.onkeydown=e=>{ if(e.key==='Enter') handleSend(); };

  // L·∫Øng nghe thay ƒë·ªïi lang/theme t·ª´ trang kh√°c
  window.addEventListener('storage', (e)=>{
    if(e.key==='theme'&&e.newValue){ setTheme(e.newValue); }
    if(e.key==='lang' &&e.newValue){ setLang(e.newValue); if(greeted){ addMsg(greetText()); } }
  });
</script>
</body>
</html>
