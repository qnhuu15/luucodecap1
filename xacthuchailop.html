<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title data-i18n="page.title">SmartExpense ‚Äî X√°c th·ª±c hai l·ªõp</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eaf3f9; --card:#fff; --text:#0f172a; --muted:#64748b;
    --border:#e5e7eb; --blue:#2563eb; --blue-700:#1e49d6; --green:#22c55e; --red:#ef4444;
    --radius:14px; --shadow:0 10px 26px rgba(15,23,42,.06); --h:44px;
    /* chat */
    --chat-bg:#f4fbff; --chat-dot:#9ca3af;
  }
  html.dark{
    --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#9aa4b2;
    --border:#1f2a44; --blue:#3b82f6; --blue-700:#2762ea; --green:#22c55e; --red:#f87171;
    --chat-bg:#071520; --chat-dot:#9aa4b2;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:grid;grid-template-columns:260px 1fr;min-height:100vh;
  }
  input,textarea,select,button{font:inherit;color:inherit}

  /* Sidebar */
  .sidebar{background:var(--card);border-right:1px solid var(--border);padding:18px 14px}
  .brand{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .brand .logo{width:40px;height:40px;border-radius:10px;overflow:hidden;background:#ffe8e0;display:grid;place-items:center;box-shadow:var(--shadow)}
  .brand .logo img{width:100%;height:100%;object-fit:cover}
  .brand b{font-size:18px}
  .nav{display:flex;flex-direction:column;gap:6px}
  .nav a{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;color:var(--text);font-weight:700;text-decoration:none}
  .nav a:hover{background:rgba(37,99,235,.12)}
  html.dark .nav a:hover{background:rgba(59,130,246,.15)}
  .nav a.active{background:var(--blue);color:#fff}

  /* Main */
  .main{padding:22px 24px 40px}
  .wrap{max-width:980px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
  .title{font-size:24px;font-weight:800;margin:0 0 6px}
  .desc{color:var(--muted);margin:0 0 18px}
  .row{display:grid;gap:8px;margin-bottom:14px}
  label{font-weight:700}
  .muted{color:var(--muted)}

  .tabs{display:flex;gap:10px;margin:6px 0 14px}
  .tab{height:38px;padding:0 14px;border-radius:999px;border:1px solid var(--border);background:var(--card);font-weight:800;cursor:pointer;color:var(--text)}
  .tab.active{background:var(--blue);border-color:var(--blue);color:#fff}

  .grid{display:grid;grid-template-columns:1.1fr 0.9fr;gap:16px}
  .section-title{font-weight:800;margin:0 0 8px}
  .two-col{display:grid;grid-template-columns:200px 1fr;gap:14px}

  .box{border:1px dashed #cbd5e1;border-radius:12px;padding:14px;background:#f8fafc}
  html.dark .box{background:#0b1626;border-color:#1f2a44}
  .qr{width:180px;height:180px;border-radius:12px;background:linear-gradient(135deg,#e2e8f0,#f8fafc);display:grid;place-items:center;border:1px solid #e5e7eb}
  html.dark .qr{background:linear-gradient(135deg,#0f172a,#0b1626);border-color:#1f2a44}
  .qr svg{width:120px;height:120px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

  .input{position:relative;height:var(--h);display:flex;align-items:center;border:1px solid var(--border);border-radius:12px;background:var(--card)}
  .input input{flex:1;height:100%;border:0;outline:none;background:var(--card);padding:0 12px;font-size:16px;border-radius:12px;color:var(--text)}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
  .btn{height:44px;border-radius:12px;padding:0 16px;font-weight:800;cursor:pointer}
  .btn-primary{background:var(--blue);color:#fff;border:0}
  .btn-primary:disabled{opacity:.6;cursor:not-allowed}
  .btn-primary:hover{filter:brightness(.96)}
  .btn-ghost{background:var(--card);border:1px solid var(--border);color:var(--text)}
  .btn-soft{background:#f1f5f9;border:1px solid #e2e8f0;color:#0f172a}
  html.dark .btn-soft{background:#0e1928;border-color:#1f2a44;color:#e5e7eb}

  .ok{color:var(--green);font-weight:700}
  .err{color:var(--red);font-weight:700}

  .codes{display:grid;grid-template-columns:repeat(2,minmax(140px,1fr));gap:8px}
  .code{background:#0f172a;color:#e5e7eb;padding:8px 10px;border-radius:10px;font-weight:800;letter-spacing:.5px}

  .toast{position:fixed;right:24px;bottom:24px;background:var(--card);border:1px solid var(--border);
    box-shadow:var(--shadow);padding:12px 14px;border-radius:12px;display:none;z-index:50;color:var(--text)}

  /* Chatbox (ƒë·ªìng b·ªô) */
  .pig-float{position:fixed;right:26px;bottom:26px;width:76px;height:76px;border-radius:18px;background:#ffe8e0;display:grid;place-items:center;box-shadow:var(--shadow);z-index:30;border:0;cursor:pointer}
  .pig-float img{width:64px;height:64px}
  .chatbox{position:fixed;right:26px;bottom:112px;width:340px;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;display:none;z-index:40;grid-template-rows:56px 1fr 60px}
  .chatbox.open{display:grid}
  .chat-head{background:#1da1c9;color:#fff;display:flex;align-items:center;gap:10px;padding:10px 12px;font-weight:800}
  .chat-head img{width:28px;height:28px;border-radius:6px;background:#ffe8e0}
  .chat-title{line-height:1.2}
  .chat-body{background:var(--chat-bg);overflow:auto;padding:10px;max-height:380px}
  .msg{display:flex;align-items:flex-end;margin:8px 0;gap:8px}
  .msg.user{justify-content:flex-end}
  .bubble{max-width:78%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:var(--card);font-size:14px;color:var(--text)}
  .msg.bot .bubble{border-radius:14px 14px 14px 4px}
  .msg.user .bubble{border-radius:14px 14px 4px 14px;background:var(--blue);border:none;color:#fff}
  .avatar-s{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;background:#ffe8e0;flex:0 0 26px;font-size:14px}
  .chat-input{background:var(--card);border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;padding:8px}
  #chatInput{flex:1;height:40px;border:1px solid var(--border);border-radius:999px;padding:0 12px;outline:none;background:var(--card);color:#var(--text)}
  #chatInput:focus{box-shadow:none;border-color:var(--border)}
  #sendBtn{width:38px;height:38px;border-radius:999px;border:0;background:var(--blue);color:#fff;display:grid;place-items:center;cursor:pointer}

  @media (max-width:1060px){
    body{grid-template-columns:1fr}
    .sidebar{position:sticky;top:0;z-index:10}
    .wrap{max-width:none}
    .grid{grid-template-columns:1fr}
    .chatbox{right:16px;bottom:96px;width:min(92vw,360px)}
    .pig-float{right:16px}
  }
</style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"><img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt=""></div>
      <b>SmartExpense</b>
    </div>
    <nav class="nav">
      <a href="trangchu.html">üè† <span data-i18n="nav.overview">T·ªïng quan</span></a>
      <a href="danhsachchitieu.html">üßæ <span data-i18n="nav.list">Danh s√°ch chi ti√™u</span></a>
      <a href="lichsuchitieu.html">üïò <span data-i18n="nav.history">L·ªãch s·ª≠ chi ti√™u</span></a>
      <a href="lenlichchitieu.html">üìÖ <span data-i18n="nav.schedule">L√™n l·ªãch chi ti√™u</span></a>
      <a href="loaichitieu.html">üè∑Ô∏è <span data-i18n="nav.types">Lo·∫°i chi ti√™u</span></a>
      <a href="baocao.html">üìä <span data-i18n="nav.report">B√°o c√°o</span></a>
      <a href="hoso.html">üë§ <span data-i18n="nav.profile">H·ªì s∆°</span></a>
      <a href="caidat.html" class="active">‚öôÔ∏è <span data-i18n="nav.settings">C√†i ƒë·∫∑t</span></a>
      <a href="login.html">‚Ü™Ô∏è <span data-i18n="nav.logout">ƒêƒÉng xu·∫•t</span></a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="wrap">
      <div class="card">
        <h1 class="title" data-i18n="2fa.title">X√°c th·ª±c hai l·ªõp (2FA)</h1>
        <p class="desc" data-i18n="2fa.desc">TƒÉng c∆∞·ªùng b·∫£o m·∫≠t b·∫±ng m√£ m·ªôt l·∫ßn. B·∫°n c√≥ th·ªÉ d√πng ·ª©ng d·ª•ng Authenticator ho·∫∑c nh·∫≠n m√£ qua SMS.</p>

        <div class="tabs">
          <button class="tab active" id="tabApp" data-i18n="tab.app">Authenticator app</button>
          <button class="tab" id="tabSMS" data-i18n="tab.sms">SMS</button>
        </div>

        <div class="grid">
          <!-- LEFT: Setup APP -->
          <section id="appPanel">
            <h3 class="section-title" data-i18n="app.setup">Thi·∫øt l·∫≠p v·ªõi ·ª©ng d·ª•ng Authenticator</h3>
            <div class="two-col">
              <div>
                <div class="box">
                  <div class="qr" id="qrBox">
                    <svg viewBox="0 0 120 120" aria-hidden="true">
                      <rect x="0" y="0" width="120" height="120" rx="8" fill="#111827"/>
                      <rect x="12" y="12" width="24" height="24" fill="#fff"/>
                      <rect x="84" y="12" width="24" height="24" fill="#fff"/>
                      <rect x="12" y="84" width="24" height="24" fill="#fff"/>
                      <rect x="48" y="48" width="24" height="24" fill="#fff"/>
                    </svg>
                  </div>
                  <div style="margin-top:10px">
                    <div class="muted" data-i18n="app.manual">Ho·∫∑c nh·∫≠p kh√≥a th·ªß c√¥ng:</div>
                    <div class="mono" id="secret" style="font-weight:800;margin:4px 0"></div>
                    <button class="btn btn-soft" id="copySecret" data-i18n="btn.copySecret">Sao ch√©p kh√≥a</button>
                  </div>
                </div>
              </div>

              <div>
                <div class="row">
                  <label data-i18n="app.enterCode">Nh·∫≠p m√£ 6 s·ªë t·ª´ ·ª©ng d·ª•ng</label>
                  <div class="input"><input id="otpApp" inputmode="numeric" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                  <div id="msgApp" class="muted"></div>
                </div>
                <div class="actions">
                  <button class="btn btn-ghost" id="resetApp" data-i18n="btn.newSecret">T·∫°o kh√≥a m·ªõi</button>
                  <button class="btn btn-primary" id="enableApp" disabled data-i18n="btn.enable2fa">K√≠ch ho·∫°t 2FA</button>
                </div>
              </div>
            </div>
          </section>

          <!-- LEFT: SMS -->
          <section id="smsPanel" style="display:none">
            <h3 class="section-title" data-i18n="sms.setup">Thi·∫øt l·∫≠p qua SMS</h3>
            <div class="row">
              <label data-i18n="sms.phone">S·ªë ƒëi·ªán tho·∫°i</label>
              <div class="input"><input id="phone" placeholder="+84xxxxxxxxx"></div>
            </div>
            <div class="row"><button class="btn btn-soft" id="sendSMS" data-i18n="sms.send">G·ª≠i m√£</button></div>
            <div class="row">
              <label data-i18n="sms.enterCode">Nh·∫≠p m√£ 6 s·ªë</label>
              <div class="input"><input id="otpSMS" inputmode="numeric" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
              <div id="msgSMS" class="muted"></div>
            </div>
            <div class="actions"><button class="btn btn-primary" id="enableSMS" disabled data-i18n="btn.enable2fa">K√≠ch ho·∫°t 2FA</button></div>
          </section>

          <!-- RIGHT -->
          <aside>
            <h3 class="section-title" data-i18n="status.title">Tr·∫°ng th√°i</h3>
            <div id="status"><span class="muted" data-i18n="status.off">Ch∆∞a b·∫≠t 2FA</span></div>

            <h3 class="section-title" style="margin-top:16px" data-i18n="rcv.title">M√£ kh√¥i ph·ª•c</h3>
            <p class="muted" id="rcvHint" data-i18n="rcv.hint">Sinh sau khi k√≠ch ho·∫°t. L∆∞u ·ªü n∆°i an to√†n; m·ªói m√£ d√πng ƒë∆∞·ª£c m·ªôt l·∫ßn.</p>
            <div class="codes" id="codes" style="display:none"></div>
            <div class="actions" id="codesActions" style="display:none">
              <button class="btn btn-soft" id="copyCodes" data-i18n="btn.copy">Sao ch√©p</button>
              <button class="btn btn-ghost" id="downloadTxt" data-i18n="btn.download">T·∫£i .txt</button>
            </div>

            <div class="actions" style="margin-top:16px">
              <button class="btn btn-ghost" id="disable" style="display:none" data-i18n="btn.disable">T·∫Øt 2FA</button>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast">‚úÖ <span data-i18n="toast.enabled">ƒê√£ k√≠ch ho·∫°t x√°c th·ª±c hai l·ªõp!</span></div>

  <!-- Chatbox -->
  <div id="chatbox" class="chatbox" aria-hidden="true">
    <div class="chat-head">
      <img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt="">
      <div>
        <div class="chat-title" data-i18n="chat.title">Tr·ª£ l√Ω th√¥ng minh</div>
        <div class="muted" style="color:#e6f6ff" data-i18n="chat.sub">H·ªó tr·ª£ b·∫≠t 2FA</div>
      </div>
    </div>
    <div id="chatBody" class="chat-body"></div>
    <div class="chat-input">
      <input id="chatInput" type="text" placeholder="Vi·∫øt tin nh·∫Øn‚Ä¶" data-i18n="ph.chat">
      <!-- CH·ªà D·ªäCH THU·ªòC T√çNH, GI·ªÆ M≈®I T√äN -->
      <button id="sendBtn" title="G·ª≠i" aria-label="G·ª≠i" data-i18n="send.title" data-i18n-attr="title,aria-label">‚û§</button>
    </div>
  </div>
  <!-- CH·ªà D·ªäCH THU·ªòC T√çNH, GI·ªÆ ·∫¢NH HEO -->
  <button id="chatToggle" class="pig-float" aria-label="M·ªü tr·ª£ l√Ω" data-i18n="chat.open" data-i18n-attr="aria-label">
    <img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt="">
  </button>

<script>
  /* ===== Theme & Language (ƒë·ªìng b·ªô) ===== */
  function getLang(){let l=localStorage.getItem('lang');if(!l){l=(navigator.language||'vi').toLowerCase().startsWith('vi')?'vi':'en';localStorage.setItem('lang',l);}return l;}
  function setLang(l){localStorage.setItem('lang',l);document.documentElement.setAttribute('lang',l);translatePage();}
  function getTheme(){return localStorage.getItem('theme')||'light'}
  function setTheme(t){localStorage.setItem('theme',t);document.documentElement.classList.toggle('dark',t==='dark');}

  const I18N={
    vi:{ "page.title":"SmartExpense ‚Äî X√°c th·ª±c hai l·ªõp","nav.overview":"T·ªïng quan","nav.list":"Danh s√°ch chi ti√™u","nav.history":"L·ªãch s·ª≠ chi ti√™u","nav.schedule":"L√™n l·ªãch chi ti√™u","nav.types":"Lo·∫°i chi ti√™u","nav.report":"B√°o c√°o","nav.profile":"H·ªì s∆°","nav.settings":"C√†i ƒë·∫∑t","nav.logout":"ƒêƒÉng xu·∫•t","2fa.title":"X√°c th·ª±c hai l·ªõp (2FA)","2fa.desc":"TƒÉng c∆∞·ªùng b·∫£o m·∫≠t b·∫±ng m√£ m·ªôt l·∫ßn. B·∫°n c√≥ th·ªÉ d√πng ·ª©ng d·ª•ng Authenticator ho·∫∑c nh·∫≠n m√£ qua SMS.","tab.app":"Authenticator app","tab.sms":"SMS","app.setup":"Thi·∫øt l·∫≠p v·ªõi ·ª©ng d·ª•ng Authenticator","app.manual":"Ho·∫∑c nh·∫≠p kh√≥a th·ªß c√¥ng:","app.enterCode":"Nh·∫≠p m√£ 6 s·ªë t·ª´ ·ª©ng d·ª•ng","sms.setup":"Thi·∫øt l·∫≠p qua SMS","sms.phone":"S·ªë ƒëi·ªán tho·∫°i","sms.send":"G·ª≠i m√£","sms.enterCode":"Nh·∫≠p m√£ 6 s·ªë","btn.copySecret":"Sao ch√©p kh√≥a","btn.newSecret":"T·∫°o kh√≥a m·ªõi","btn.enable2fa":"K√≠ch ho·∫°t 2FA","btn.copy":"Sao ch√©p","btn.download":"T·∫£i .txt","btn.disable":"T·∫Øt 2FA","status.title":"Tr·∫°ng th√°i","status.off":"Ch∆∞a b·∫≠t 2FA","status.on":"ƒêang b·∫≠t 2FA","rcv.title":"M√£ kh√¥i ph·ª•c","rcv.hint":"Sinh sau khi k√≠ch ho·∫°t. L∆∞u ·ªü n∆°i an to√†n; m·ªói m√£ d√πng ƒë∆∞·ª£c m·ªôt l·∫ßn.","toast.enabled":"ƒê√£ k√≠ch ho·∫°t x√°c th·ª±c hai l·ªõp!","chat.title":"Tr·ª£ l√Ω th√¥ng minh","chat.sub":"H·ªó tr·ª£ b·∫≠t 2FA","chat.greet":"M√¨nh c√≥ th·ªÉ gi√∫p b·∫°n b·∫≠t 2FA qua App ho·∫∑c SMS. H√£y h·ªèi m√¨nh n·∫øu c·∫ßn!","chat.open":"M·ªü tr·ª£ l√Ω","ph.chat":"Vi·∫øt tin nh·∫Øn‚Ä¶","send.title":"G·ª≠i","msg.ok":"M√¨nh ƒë√£ nh·∫≠n ƒë∆∞·ª£c y√™u c·∫ßu. B·∫°n mu·ªën b·∫≠t b·∫±ng App hay SMS?" },
    en:{ "page.title":"SmartExpense ‚Äî Two-factor authentication","nav.overview":"Overview","nav.list":"Expense list","nav.history":"History","nav.schedule":"Budget planner","nav.types":"Categories","nav.report":"Reports","nav.profile":"Profile","nav.settings":"Settings","nav.logout":"Log out","2fa.title":"Two-factor authentication (2FA)","2fa.desc":"Add an extra layer of security with one-time codes. Use an Authenticator app or receive SMS codes.","tab.app":"Authenticator app","tab.sms":"SMS","app.setup":"Set up with an Authenticator app","app.manual":"Or enter the secret manually:","app.enterCode":"Enter 6-digit code from the app","sms.setup":"Set up via SMS","sms.phone":"Phone number","sms.send":"Send code","sms.enterCode":"Enter 6-digit code","btn.copySecret":"Copy secret","btn.newSecret":"Generate new secret","btn.enable2fa":"Enable 2FA","btn.copy":"Copy","btn.download":"Download .txt","btn.disable":"Disable 2FA","status.title":"Status","status.off":"2FA is off","status.on":"2FA is on","rcv.title":"Recovery codes","rcv.hint":"Generated after enabling. Store safely; each code can be used once.","toast.enabled":"Two-factor authentication enabled!","chat.title":"Smart assistant","chat.sub":"2FA helper","chat.greet":"I can help you enable 2FA via App or SMS. Ask me anything!","chat.open":"Open assistant","ph.chat":"Type a message‚Ä¶","send.title":"Send","msg.ok":"Got it. Would you like to use App or SMS?" }
  };

  function t(key){const l=getLang();return (I18N[l]&&I18N[l][key])||key;}

  // ‚úÖ Kh√¥ng ghi ƒë√® icon/·∫£nh: ch·ªâ set text n·∫øu ph·∫ßn t·ª≠ kh√¥ng c√≥ con
  function translatePage(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      const val = t(key);

      if (el.hasAttribute('data-i18n-attr')) {
        el.getAttribute('data-i18n-attr')
          .split(',')
          .forEach(a => el.setAttribute(a.trim(), val));
        return;
      }

      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        el.placeholder = val; return;
      }

      if (el.children.length === 0) {
        el.textContent = val;
      }
    });

    const titleEl=document.querySelector('title[data-i18n="page.title"], title');
    if(titleEl) titleEl.textContent=t('page.title');
  }

  (function bootstrap(){setTheme(getTheme());document.documentElement.setAttribute('lang',getLang());translatePage();})();
  window.addEventListener('storage',(e)=>{
    if(e.key==='theme'&&e.newValue){ setTheme(e.newValue); }
    if(e.key==='lang' &&e.newValue){ setLang(e.newValue); }
  });

  /* ---------- Tabs ---------- */
  const tabApp=document.getElementById('tabApp'), tabSMS=document.getElementById('tabSMS'),
        appPanel=document.getElementById('appPanel'), smsPanel=document.getElementById('smsPanel');
  tabApp.onclick=()=>{tabApp.classList.add('active');tabSMS.classList.remove('active');appPanel.style.display='';smsPanel.style.display='none';};
  tabSMS.onclick=()=>{tabSMS.classList.add('active');tabApp.classList.remove('active');smsPanel.style.display='';appPanel.style.display='none';};

  /* ---------- Helpers ---------- */
  function rand(n){return Math.floor(Math.random()*n);}
  function randomBase32(len=16){const A="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let s="";for(let i=0;i<len;i++) s+=A[rand(A.length)];return s.match(/.{1,4}/g).join(' ');}
  function showToast(msg){const tEl=document.getElementById('toast');tEl.textContent='‚úÖ '+msg; tEl.style.display='block'; setTimeout(()=>tEl.style.display='none',1500);}
  function makeRecovery(count=8){const A="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";const out=[];for(let i=0;i<count;i++){let s="";for(let j=0;j<8;j++) s+=A[rand(A.length)];out.push(s.slice(0,4)+'-'+s.slice(4));}return out;}

  /* ---------- App flow ---------- */
  const secretEl=document.getElementById('secret'), otpApp=document.getElementById('otpApp'),
        msgApp=document.getElementById('msgApp'), enableApp=document.getElementById('enableApp'),
        copySecret=document.getElementById('copySecret'), resetApp=document.getElementById('resetApp');

  function resetSecret(){secretEl.textContent=randomBase32(); otpApp.value=''; enableApp.disabled=true; msgApp.textContent='';}
  resetSecret();

  otpApp.addEventListener('input', ()=>{
    const ok=/^\d{6}$/.test(otpApp.value);
    enableApp.disabled=!ok;
    msgApp.textContent= ok ? (getLang()==='en'?'Code looks valid. Ready to enable.':'M√£ h·ª£p l·ªá, s·∫µn s√†ng k√≠ch ho·∫°t.') : (getLang()==='en'?'Enter exactly 6 digits.':'Nh·∫≠p ƒë√∫ng 6 ch·ªØ s·ªë.');
    msgApp.className= ok ? 'ok' : 'muted';
  });
  copySecret.onclick=()=>{navigator.clipboard.writeText(secretEl.textContent.replace(/\s/g,''));showToast(getLang()==='en'?'Secret copied.':'ƒê√£ sao ch√©p kh√≥a.');};
  resetApp.onclick=resetSecret;

  /* ---------- SMS flow ---------- */
  const phone=document.getElementById('phone'), sendSMS=document.getElementById('sendSMS'),
        otpSMS=document.getElementById('otpSMS'), msgSMS=document.getElementById('msgSMS'),
        enableSMS=document.getElementById('enableSMS');

  sendSMS.onclick=()=>{ if(!phone.value.trim()){ alert(getLang()==='en'?'Enter phone first.':'Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i tr∆∞·ªõc.'); return; } showToast(getLang()==='en'?'Code sent (demo).':'ƒê√£ g·ª≠i m√£ (demo).'); };
  otpSMS.addEventListener('input', ()=>{
    const ok=/^\d{6}$/.test(otpSMS.value);
    enableSMS.disabled=!ok;
    msgSMS.textContent= ok ? (getLang()==='en'?'Code looks valid. Ready to enable.':'M√£ h·ª£p l·ªá, s·∫µn s√†ng k√≠ch ho·∫°t.') : (getLang()==='en'?'Enter exactly 6 digits.':'Nh·∫≠p ƒë√∫ng 6 ch·ªØ s·ªë.');
    msgSMS.className= ok ? 'ok' : 'muted';
  });

  /* ---------- Status & Recovery ---------- */
  let enabled=false;
  const status=document.getElementById('status'), codesBox=document.getElementById('codes'),
        codesActions=document.getElementById('codesActions'), rcvHint=document.getElementById('rcvHint'),
        disableBtn=document.getElementById('disable'), copyCodes=document.getElementById('copyCodes'),
        downloadTxt=document.getElementById('downloadTxt');

  function setEnabled(v){
    enabled=v;
    if(v){
      status.innerHTML=`<span class="ok">${t('status.on')}</span>`;
      disableBtn.style.display='';
      const codes=makeRecovery();
      codesBox.innerHTML=codes.map(c=>`<div class="code mono">${c}</div>`).join('');
      codesBox.style.display='grid'; codesActions.style.display='flex';
      rcvHint.textContent=t('rcv.hint');
      copyCodes.onclick=()=>{navigator.clipboard.writeText(codes.join('\n'));showToast(getLang()==='en'?'Recovery codes copied.':'ƒê√£ sao ch√©p m√£ kh√¥i ph·ª•c.');};
      downloadTxt.onclick=()=>{const blob=new Blob([codes.join('\n')],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='recovery-codes.txt';a.click();URL.revokeObjectURL(url);};
    }else{
      status.innerHTML=`<span class="muted">${t('status.off')}</span>`;
      disableBtn.style.display='none';
      codesBox.style.display='none'; codesActions.style.display='none';
      rcvHint.textContent=t('rcv.hint');
    }
  }
  setEnabled(false);

  function toastEnabled(){showToast(t('toast.enabled'));}

  document.getElementById('enableApp').onclick=()=>{setEnabled(true);toastEnabled();};
  document.getElementById('enableSMS').onclick=()=>{setEnabled(true);toastEnabled();};
  disableBtn.onclick=()=>{ if(confirm(getLang()==='en'?'Turn off 2FA?':'T·∫Øt x√°c th·ª±c hai l·ªõp?')){ setEnabled(false); showToast(getLang()==='en'?'2FA turned off.':'ƒê√£ t·∫Øt 2FA.'); } };

  /* ---------- Chatbox ---------- */
  const chatToggle=document.getElementById('chatToggle'), chatbox=document.getElementById('chatbox'),
        chatBody=document.getElementById('chatBody'), chatInput=document.getElementById('chatInput'),
        sendBtn=document.getElementById('sendBtn');
  let greeted=false;

  function addMsg(text,who='bot'){
    const wrap=document.createElement('div'); wrap.className=`msg ${who}`;
    const av=document.createElement('div'); av.className='avatar-s'; av.textContent=who==='bot'?'üê∑':'üë§';
    const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
    if(who==='bot'){wrap.append(av,b);} else {wrap.append(b,av);}
    chatBody.appendChild(wrap); chatBody.scrollTop=chatBody.scrollHeight;
  }
  function greetText(){return t('chat.greet');}
  function updateGreeting(){const g=document.querySelector('.bubble[data-greeting="1"]'); if(g) g.textContent=greetText();}

  function openChat(){
    chatbox.classList.add('open'); chatbox.setAttribute('aria-hidden','false');
    if(!greeted){
      const wrap=document.createElement('div'); wrap.className='msg bot';
      const av=document.createElement('div'); av.className='avatar-s'; av.textContent='üê∑';
      const b=document.createElement('div'); b.className='bubble'; b.setAttribute('data-greeting','1'); b.textContent=greetText();
      wrap.append(av,b); chatBody.appendChild(wrap); greeted=true;
    }
    setTimeout(()=>chatInput.focus(),100);
  }
  function closeChat(){ chatbox.classList.remove('open'); chatbox.setAttribute('aria-hidden','true'); }
  chatToggle.addEventListener('click', ()=> chatbox.classList.contains('open') ? closeChat() : openChat());

  function handleSend(){
    const ttxt=chatInput.value.trim(); if(!ttxt) return;
    addMsg(ttxt,'user'); chatInput.value='';
    const k=ttxt.toLowerCase();
    if(k.includes('app')||k.includes('qr')) addMsg(getLang()==='en'?'Open Google/Microsoft Authenticator and add an account via QR or enter the secret.':'M·ªü Google/Microsoft Authenticator, th√™m t√†i kho·∫£n b·∫±ng qu√©t QR ho·∫∑c nh·∫≠p kh√≥a th·ªß c√¥ng.');
    else if(k.includes('sms')) addMsg(getLang()==='en'?'Enter your phone number, tap ‚ÄúSend code‚Äù, then enter the 6 digits to enable.':'Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i r·ªìi b·∫•m ‚ÄúG·ª≠i m√£‚Äù, sau ƒë√≥ nh·∫≠p 6 s·ªë ƒë·ªÉ k√≠ch ho·∫°t.');
    else if(k.includes('kh√¥i ph·ª•c')||k.includes('backup')||k.includes('recovery')) addMsg(getLang()==='en'?'After enabling 2FA, 8 one-time recovery codes will be generated. Save or download them as .txt.':'Sau khi b·∫≠t 2FA, h·ªá th·ªëng sinh 8 m√£ kh√¥i ph·ª•c ‚Äî m·ªói m√£ d√πng 1 l·∫ßn. H√£y sao l∆∞u ho·∫∑c t·∫£i .txt.');
    else addMsg(t('msg.ok'));
  }
  sendBtn.addEventListener('click', handleSend);
  chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter') handleSend(); });

  window.addEventListener('storage',(e)=>{
    if(e.key==='theme'&&e.newValue){ setTheme(e.newValue); }
    if(e.key==='lang' &&e.newValue){ setLang(e.newValue); updateGreeting(); }
  });
</script>
</body>
</html>
