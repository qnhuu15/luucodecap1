<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title data-i18n="page.title">SmartExpense ‚Äî Xu·∫•t d·ªØ li·ªáu</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eaf3f9; --card:#fff; --text:#0f172a; --muted:#64748b;
    --border:#e5e7eb; --blue:#2563eb; --green:#16a34a; --red:#ef4444;
    --radius:14px; --shadow:0 10px 26px rgba(15,23,42,.06);
    --soft:#f8fafc; --chat-bg:#f4fbff;
  }
  html.dark{
    --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#9aa4b2;
    --border:#1f2a44; --blue:#3b82f6; --green:#16a34a; --red:#f87171;
    --soft:#0e1928; --chat-bg:#071520;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:grid;grid-template-columns:260px 1fr;min-height:100vh;
  }

  /* Sidebar */
  .sidebar{background:var(--card);border-right:1px solid var(--border);padding:18px 14px}
  .brand{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .brand .logo{width:40px;height:40px;border-radius:10px;overflow:hidden;background:#ffe8e0;display:grid;place-items:center;box-shadow:var(--shadow)}
  .brand .logo img{width:100%;height:100%;object-fit:cover}
  .brand b{font-size:18px}
  .nav{display:flex;flex-direction:column;gap:6px}
  .nav a{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;color:var(--text);font-weight:700;text-decoration:none}
  .nav a.active{background:var(--blue);color:#fff}

  /* Main */
  .main{padding:22px 24px 40px}
  .wrap{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:18px;max-width:1200px}
  h1{margin:0 0 10px;font-size:24px;font-weight:800}
  .grid{display:grid;grid-template-columns:1fr .8fr;gap:16px}
  .section{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--card)}
  .section h3{margin:0 0 10px;font-size:18px;font-weight:800}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0}
  label{font-weight:700}
  .input, select, .chip{height:38px;border:1px solid var(--border);border-radius:10px;background:var(--soft);padding:0 12px;outline:none;color:var(--text)}
  .chip{display:inline-flex;align-items:center;font-weight:800;cursor:pointer}
  .chip.active{background:#0f172a;color:#fff;border-color:#0f172a}
  .btn{height:40px;border-radius:10px;padding:0 14px;font-weight:800;cursor:pointer}
  .btn-primary{background:var(--blue);color:#fff;border:0}
  .btn-ghost{background:var(--card);border:1px solid var(--border);color:var(--text)}
  .btn-danger{background:var(--card);border:1px solid #fecaca;color:#b91c1c}
  .muted{color:var(--muted)}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px}
  html.dark .table th, html.dark .table td{border-bottom:1px solid #1f2a44}
  .hint{color:var(--muted);font-size:13px;margin-top:8px}

  /* Chatbox */
  .pig-float{
    position:fixed;right:26px;bottom:26px;width:76px;height:76px;border-radius:18px;
    background:#ffe8e0;display:grid;place-items:center;box-shadow:var(--shadow);
    z-index:30;border:0;cursor:pointer
  }
  .pig-float img{width:64px;height:64px}
  .chatbox{
    position:fixed;right:26px;bottom:112px;width:340px;background:var(--card);border:1px solid var(--border);
    border-radius:14px;box-shadow:var(--shadow);overflow:hidden;display:none;z-index:40;grid-template-rows:56px 1fr 60px;
  }
  .chatbox.open{display:grid}
  .chat-head{background:#1da1c9;color:#fff;display:flex;align-items:center;gap:10px;padding:10px 12px;font-weight:800}
  .chat-head img{width:28px;height:28px;border-radius:6px;background:#ffe8e0}
  .chat-body{background:var(--chat-bg);overflow:auto;padding:10px;max-height:380px}
  .msg{display:flex;align-items:flex-end;margin:8px 0;gap:8px}
  .bubble{max-width:78%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:var(--card);font-size:14px;color:var(--text)}
  .msg.user{justify-content:flex-end}
  .msg.user .bubble{background:var(--blue);border:none;color:#fff}
  .avatar-s{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;background:#ffe8e0;flex:0 0 26px;font-size:14px}
  .chat-input{background:var(--card);border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;padding:8px}
  #chatInput{flex:1;height:40px;border:1px solid var(--border);border-radius:999px;padding:0 12px;outline:none;background:var(--card);color:var(--text)}
  #sendBtn{width:38px;height:38px;border-radius:999px;border:0;background:var(--blue);color:#fff;display:grid;place-items:center;cursor:pointer}

  @media (max-width:1100px){
    body{grid-template-columns:1fr}
    .sidebar{position:sticky;top:0;z-index:20}
    .wrap{max-width:none}
    .grid{grid-template-columns:1fr}
    .chatbox{right:16px;bottom:96px;width:min(92vw,360px)}
    .pig-float{right:16px}
  }
</style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"><img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt=""></div>
      <b>SmartExpense</b>
    </div>
    <nav class="nav">
      <a href="trangchu.html">üè† <span data-i18n="nav.overview">T·ªïng quan</span></a>
      <a href="danhsachchitieu.html">üßæ <span data-i18n="nav.list">Danh s√°ch chi ti√™u</span></a>
      <a href="lichsuchitieu.html">üïò <span data-i18n="nav.history">L·ªãch s·ª≠ chi ti√™u</span></a>
      <a href="lenlichchitieu.html">üìÖ <span data-i18n="nav.schedule">L√™n l·ªãch chi ti√™u</span></a>
      <a href="loaichitieu.html">üè∑Ô∏è <span data-i18n="nav.types">Lo·∫°i chi ti√™u</span></a>
      <a href="baocao.html">üìä <span data-i18n="nav.report">B√°o c√°o</span></a>
      <a href="hoso.html">üë§ <span data-i18n="nav.profile">H·ªì s∆°</span></a>
      <a href="caidat.html" class="active">‚öôÔ∏è <span data-i18n="nav.settings">C√†i ƒë·∫∑t</span></a>
      <a href="login.html">‚Ü™Ô∏è <span data-i18n="nav.logout">ƒêƒÉng xu·∫•t</span></a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="wrap">
      <h1 data-i18n="page.h1">Xu·∫•t d·ªØ li·ªáu</h1>
      <div class="grid">
        <!-- LEFT: form -->
        <section class="section">
          <h3 data-i18n="cfg.title">C·∫•u h√¨nh</h3>

          <div class="row">
            <label data-i18n="cfg.ds">Lo·∫°i d·ªØ li·ªáu</label>
            <span class="chip active" data-ds="expenses" data-i18n="ds.expenses">Chi ti√™u</span>
            <span class="chip" data-ds="categories" data-i18n="ds.categories">Lo·∫°i chi ti√™u</span>
            <span class="chip" data-ds="devices" data-i18n="ds.devices">Thi·∫øt b·ªã</span>
          </div>

          <div class="row" id="dateRow">
            <label data-i18n="cfg.range">Kho·∫£ng th·ªùi gian</label>
            <input id="from" type="date" class="input">
            <span class="muted">‚Üí</span>
            <input id="to" type="date" class="input">
            <span class="chip" data-range="7d" data-i18n="range.7d">7 ng√†y</span>
            <span class="chip" data-range="30d" data-i18n="range.30d">30 ng√†y</span>
            <span class="chip" data-range="ytd" data-i18n="range.ytd">NƒÉm nay</span>
          </div>

          <div class="row" id="fieldsRow">
            <label data-i18n="cfg.fields">Tr∆∞·ªùng d·ªØ li·ªáu</label>
            <label><input type="checkbox" class="fld" value="date" checked> <span data-i18n="fld.date">Ng√†y</span></label>
            <label><input type="checkbox" class="fld" value="category" checked> <span data-i18n="fld.category">Lo·∫°i</span></label>
            <label><input type="checkbox" class="fld" value="amount" checked> <span data-i18n="fld.amount">S·ªë ti·ªÅn</span></label>
            <label><input type="checkbox" class="fld" value="note"> <span data-i18n="fld.note">Ghi ch√∫</span></label>
            <label><input type="checkbox" class="fld" value="method"> <span data-i18n="fld.method">Ph∆∞∆°ng th·ª©c</span></label>
          </div>

          <div class="row">
            <label data-i18n="cfg.format">ƒê·ªãnh d·∫°ng</label>
            <select id="format" class="input">
              <option value="csv">CSV</option>
              <option value="json">JSON</option>
            </select>
            <label><input id="header" type="checkbox" checked> <span data-i18n="cfg.header">K√®m d√≤ng ti√™u ƒë·ªÅ</span></label>
            <label><input id="onlySelected" type="checkbox"> <span data-i18n="cfg.onlySelected">Ch·ªâ xu·∫•t c√°c tr∆∞·ªùng ƒë√£ ch·ªçn</span></label>
          </div>

          <div class="row">
            <button class="btn btn-ghost" id="previewBtn" data-i18n="btn.preview">Xem tr∆∞·ªõc</button>
            <button class="btn btn-primary" id="exportBtn" data-i18n="btn.export">Xu·∫•t d·ªØ li·ªáu</button>
            <span class="muted" id="stat"></span>
          </div>

          <div class="hint" data-i18n="hint">M·∫πo: N·∫øu d√πng Excel/Google Sheets, h√£y ch·ªçn CSV. N·∫øu mu·ªën nh·∫≠p v√†o h·ªá th·ªëng kh√°c, d√πng JSON.</div>
        </section>

        <!-- RIGHT: preview -->
        <section class="section">
          <h3 data-i18n="preview.title">Xem tr∆∞·ªõc (t·ªëi ƒëa 15 d√≤ng)</h3>
          <div id="previewWrap" class="muted" data-i18n="preview.empty">Ch∆∞a c√≥ d·ªØ li·ªáu xem tr∆∞·ªõc.</div>
        </section>
      </div>
    </div>
  </main>

  <!-- Chatbox -->
  <div id="chatbox" class="chatbox" aria-hidden="true">
    <div class="chat-head">
      <img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt="">
      <div class="chat-title" data-i18n="chat.title">Tr·ª£ l√Ω th√¥ng minh</div>
    </div>
    <div id="chatBody" class="chat-body"></div>
    <div class="chat-input">
      <input id="chatInput" type="text" placeholder="Vi·∫øt tin nh·∫Øn‚Ä¶" data-i18n="ph.chat">
      <button id="sendBtn" title="G·ª≠i" aria-label="G·ª≠i" data-i18n="send.title" data-i18n-attr="title,aria-label">‚û§</button>
    </div>
  </div>
  <button id="chatToggle" class="pig-float" aria-label="M·ªü tr·ª£ l√Ω" data-i18n="chat.open" data-i18n-attr="aria-label">
    <img src="https://play-lh.googleusercontent.com/oIYzM27-Lax7Zkg4grAxxLYRQkxHrs1osx0Qbf-jADQNpv9400yo0qYcLzDn-Qz2M8A=w480-h960-rw" alt="">
  </button>

<script>
/* =================== Theme + i18n (ƒë·ªçc t·ª´ C√†i ƒë·∫∑t) =================== */
function getLang(){let l=localStorage.getItem('lang');if(!l){l=(navigator.language||'vi').toLowerCase().startsWith('vi')?'vi':'en';localStorage.setItem('lang',l);}return l;}
function setLang(l){localStorage.setItem('lang',l);document.documentElement.setAttribute('lang',l);translatePage();}
function getTheme(){return localStorage.getItem('theme')||'light'}
function setTheme(t){localStorage.setItem('theme',t);document.documentElement.classList.toggle('dark',t==='dark');}

const I18N = {
  vi:{
    "page.title":"SmartExpense ‚Äî Xu·∫•t d·ªØ li·ªáu","page.h1":"Xu·∫•t d·ªØ li·ªáu",
    "nav.overview":"T·ªïng quan","nav.list":"Danh s√°ch chi ti√™u","nav.history":"L·ªãch s·ª≠ chi ti√™u","nav.schedule":"L√™n l·ªãch chi ti√™u","nav.types":"Lo·∫°i chi ti√™u","nav.report":"B√°o c√°o","nav.profile":"H·ªì s∆°","nav.settings":"C√†i ƒë·∫∑t","nav.logout":"ƒêƒÉng xu·∫•t",
    "cfg.title":"C·∫•u h√¨nh","cfg.ds":"Lo·∫°i d·ªØ li·ªáu","cfg.range":"Kho·∫£ng th·ªùi gian","cfg.fields":"Tr∆∞·ªùng d·ªØ li·ªáu","cfg.format":"ƒê·ªãnh d·∫°ng","cfg.header":"K√®m d√≤ng ti√™u ƒë·ªÅ","cfg.onlySelected":"Ch·ªâ xu·∫•t c√°c tr∆∞·ªùng ƒë√£ ch·ªçn",
    "ds.expenses":"Chi ti√™u","ds.categories":"Lo·∫°i chi ti√™u","ds.devices":"Thi·∫øt b·ªã",
    "range.7d":"7 ng√†y","range.30d":"30 ng√†y","range.ytd":"NƒÉm nay",
    "fld.date":"Ng√†y","fld.category":"Lo·∫°i","fld.amount":"S·ªë ti·ªÅn","fld.note":"Ghi ch√∫","fld.method":"Ph∆∞∆°ng th·ª©c",
    "btn.preview":"Xem tr∆∞·ªõc","btn.export":"Xu·∫•t d·ªØ li·ªáu",
    "hint":"M·∫πo: N·∫øu d√πng Excel/Google Sheets, h√£y ch·ªçn CSV. N·∫øu mu·ªën nh·∫≠p v√†o h·ªá th·ªëng kh√°c, d√πng JSON.",
    "preview.title":"Xem tr∆∞·ªõc (t·ªëi ƒëa 15 d√≤ng)","preview.empty":"Ch∆∞a c√≥ d·ªØ li·ªáu xem tr∆∞·ªõc.","preview.no":"Kh√¥ng c√≥ d·ªØ li·ªáu.",
    "stat.rows":"d√≤ng","stat.devices":"thi·∫øt b·ªã","stat.total":"T·ªïng",
    "export.empty":"Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.",
    "chat.title":"Tr·ª£ l√Ω th√¥ng minh","chat.open":"M·ªü tr·ª£ l√Ω",
    "chat.greet":"Xin ch√†o! M√¨nh c√≥ th·ªÉ gi√∫p b·∫°n l·ªçc th·ªùi gian, ch·ªçn CSV/JSON v√† xu·∫•t d·ªØ li·ªáu.",
    "ph.chat":"Vi·∫øt tin nh·∫Øn‚Ä¶","send.title":"G·ª≠i",
    "chat.csv":"Ch·ªçn ƒë·ªãnh d·∫°ng CSV v√† b·∫•m ‚ÄúXu·∫•t d·ªØ li·ªáu‚Äù. CSV m·ªü t·ªët trong Excel/Google Sheets.",
    "chat.json":"JSON ph√π h·ª£p ƒë·ªÉ nh·∫≠p v√†o h·ªá th·ªëng kh√°c ho·∫∑c API.",
    "chat.range":"D√πng khung ng√†y t·ª´‚Äìƒë·∫øn ho·∫∑c c√°c n√∫t 7 ng√†y / 30 ng√†y / NƒÉm nay.",
    "chat.ask":"B·∫°n mu·ªën xu·∫•t lo·∫°i d·ªØ li·ªáu n√†o: Chi ti√™u, Lo·∫°i chi ti√™u hay Thi·∫øt b·ªã?"
  },
  en:{
    "page.title":"SmartExpense ‚Äî Export data","page.h1":"Export data",
    "nav.overview":"Overview","nav.list":"Expense list","nav.history":"History","nav.schedule":"Budget planner","nav.types":"Categories","nav.report":"Reports","nav.profile":"Profile","nav.settings":"Settings","nav.logout":"Log out",
    "cfg.title":"Configuration","cfg.ds":"Dataset","cfg.range":"Date range","cfg.fields":"Fields","cfg.format":"Format","cfg.header":"Include header row","cfg.onlySelected":"Only selected fields",
    "ds.expenses":"Expenses","ds.categories":"Categories","ds.devices":"Devices",
    "range.7d":"7 days","range.30d":"30 days","range.ytd":"Year to date",
    "fld.date":"Date","fld.category":"Category","fld.amount":"Amount","fld.note":"Note","fld.method":"Method",
    "btn.preview":"Preview","btn.export":"Export",
    "hint":"Tip: Use CSV for Excel/Google Sheets; use JSON to import into other systems.",
    "preview.title":"Preview (up to 15 rows)","preview.empty":"No preview yet.","preview.no":"No data.",
    "stat.rows":"rows","stat.devices":"devices","stat.total":"Total",
    "export.empty":"No data to export.",
    "chat.title":"Smart assistant","chat.open":"Open assistant",
    "chat.greet":"Hi! I can help you filter dates, choose CSV/JSON, and export data.",
    "ph.chat":"Type a message‚Ä¶","send.title":"Send",
    "chat.csv":"Choose CSV then click ‚ÄúExport‚Äù. CSV works well in Excel/Google Sheets.",
    "chat.json":"JSON is great for importing into other systems or APIs.",
    "chat.range":"Use the date range fields or quick buttons (7d / 30d / YTD).",
    "chat.ask":"Which dataset do you want to export: Expenses, Categories, or Devices?"
  }
};

function t(key){const l=getLang();return (I18N[l]&&I18N[l][key])||key;}

function translatePage(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n'); const val=t(key);
    if(el.hasAttribute('data-i18n-attr')){
      el.getAttribute('data-i18n-attr').split(',').forEach(a=>el.setAttribute(a.trim(),val));
    }else if(el.tagName==='INPUT'||el.tagName==='TEXTAREA'){
      el.placeholder = val;
    }else if(el.children.length===0){
      el.textContent = val;
    }else{
      if([...el.childNodes].every(n=>n.nodeType!==1)) el.textContent = val;
    }
  });
  const titleEl=document.querySelector('title[data-i18n="page.title"], title');
  if(titleEl) titleEl.textContent=t('page.title');
}

/* =================== Demo datasets =================== */
const CATS = ['ƒÇn u·ªëng','Di chuy·ªÉn','Gi·∫£i tr√≠','Mua s·∫Øm','H√≥a ƒë∆°n','Kh√°c'];
const METHODS = ['Ti·ªÅn m·∫∑t','Th·∫ª','V√≠ ƒëi·ªán t·ª≠'];
function pad(n){ return n.toString().padStart(2,'0'); }
function fmtDate(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

const today = new Date();
const EXPENSES = Array.from({length:80}).map((_,i)=>{
  const d = addDays(today, -Math.floor(Math.random()*120));
  return {
    id:i+1,
    date: fmtDate(d),
    category: CATS[Math.floor(Math.random()*CATS.length)],
    amount: (Math.floor(Math.random()*900)+50)*1000,
    note: Math.random()>.7 ? '‚Äî' : '',
    method: METHODS[Math.floor(Math.random()*METHODS.length)]
  };
});
const CATEGORIES = CATS.map((c,i)=>({ id:i+1, name:c, monthly_budget: [2000000,3000000,1500000,2500000,1800000,1000000][i] }));
const DEVICES = [
  {id:1, name:'iPhone 15', platform:'iOS',    browser:'Safari',  city:'H√† N·ªôi',      ip:'113.23.40.17', last:'H√¥m nay, 09:10', trusted:false, blocked:false},
  {id:2, name:'MacBook Pro', platform:'macOS', browser:'Chrome',  city:'HCM',         ip:'27.3.145.80',   last:'H√¥m nay, 08:02', trusted:true,  blocked:false},
  {id:3, name:'Windows PC',  platform:'Windows',browser:'Edge',   city:'ƒê√† N·∫µng',     ip:'14.162.6.201',  last:'H√¥m qua, 22:03', trusted:false, blocked:false},
  {id:4, name:'Android Tab', platform:'Android',browser:'Chrome', city:'Singapore',   ip:'103.10.12.2',   last:'2 ng√†y tr∆∞·ªõc',   trusted:false, blocked:true}
];

/* =================== UI state =================== */
let dataset = 'expenses';
const chips = [...document.querySelectorAll('.chip[data-ds]')];
chips.forEach(ch => ch.onclick = () => {
  chips.forEach(x=>x.classList.remove('active')); ch.classList.add('active');
  dataset = ch.dataset.ds;
  document.getElementById('dateRow').style.display = dataset==='expenses' ? 'flex' : 'none';
  document.getElementById('fieldsRow').style.display = dataset==='expenses' ? 'flex' : 'none';
  document.getElementById('previewWrap').setAttribute('data-i18n','preview.empty');
  document.getElementById('previewWrap').textContent = t('preview.empty');
  document.getElementById('stat').textContent = '';
});

/* ranges */
const from = document.getElementById('from');
const to   = document.getElementById('to');
function setRange(type){
  const now=new Date(); let a,b;
  if(type==='7d'){ b=now; a=addDays(now,-6); }
  if(type==='30d'){ b=now; a=addDays(now,-29); }
  if(type==='ytd'){ a=new Date(now.getFullYear(),0,1); b=now; }
  from.value=fmtDate(a); to.value=fmtDate(b);
}
document.querySelectorAll('.chip[data-range]').forEach(x=> x.onclick = ()=> setRange(x.dataset.range));
setRange('30d');

/* fields */
function selectedFields(){
  return [...document.querySelectorAll('.fld')].filter(x=>x.checked).map(x=>x.value);
}

/* filtering */
function filterExpenses(){
  const a = from.value ? new Date(from.value) : null;
  const b = to.value ? new Date(to.value) : null;
  return EXPENSES.filter(r=>{
    const d = new Date(r.date);
    return (!a || d>=a) && (!b || d<=b);
  });
}

/* helpers */
function download(filename, mime, content){
  const blob=new Blob([content],{type:mime});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
}
function toCSV(rows, includeHeader=true){
  if(!rows.length) return '';
  const cols = Object.keys(rows[0]);
  const escape = v => {
    const s = (v===null||v===undefined) ? '' : ''+v;
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  const head = includeHeader ? cols.join(',')+'\n' : '';
  return head + rows.map(r => cols.map(c=>escape(r[c] ?? '')).join(',')).join('\n');
}

/* preview */
const previewWrap = document.getElementById('previewWrap');
const stat = document.getElementById('stat');
function renderPreview(rows){
  if(!rows.length){
    previewWrap.setAttribute('data-i18n','preview.no');
    previewWrap.textContent = t('preview.no');
    return;
  }
  const cols = Object.keys(rows[0]);
  const top = rows.slice(0,15);
  const thead = '<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';
  const tbody = top.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]}</td>`).join('')+'</tr>').join('');
  previewWrap.removeAttribute('data-i18n');
  previewWrap.innerHTML = `<div style="overflow:auto"><table class="table">${thead}${tbody}</table></div>`;
}

/* main actions */
document.getElementById('previewBtn').onclick = ()=>{
  let rows=[];
  if(dataset==='expenses'){
    const fields = selectedFields();
    const onlySel = document.getElementById('onlySelected').checked;
    rows = filterExpenses().map(r=>{
      if(!onlySel) return r;
      const o={}; fields.forEach(f=>o[f]=r[f]); return o;
    });
    const total = rows.reduce((s,r)=> s+(+r.amount||0), 0);
    stat.textContent = `${rows.length} ${t('stat.rows')} ‚Ä¢ ${t('stat.total')} ${total.toLocaleString(getLang()==='vi'?'vi-VN':'en-US')} ${getLang()==='vi'?'ƒë':''}`;
  }else if(dataset==='categories'){
    rows = CATEGORIES;
    stat.textContent = `${rows.length} ${t('stat.rows')}`;
  }else if(dataset==='devices'){
    rows = DEVICES;
    stat.textContent = `${rows.length} ${t('stat.devices')}`;
  }
  renderPreview(rows);
};

document.getElementById('exportBtn').onclick = ()=>{
  const fmt = document.getElementById('format').value;
  const includeHeader = document.getElementById('header').checked;
  let rows=[];
  if(dataset==='expenses'){
    const fields = selectedFields();
    const onlySel = document.getElementById('onlySelected').checked;
    rows = filterExpenses().map(r=>{
      if(!onlySel) return r;
      const o={}; fields.forEach(f=>o[f]=r[f]); return o;
    });
  }else if(dataset==='categories'){ rows = CATEGORIES; }
  else if(dataset==='devices'){ rows = DEVICES; }

  if(!rows.length){ alert(t('export.empty')); return; }

  const stamp = fmtDate(new Date()).replace(/-/g,'');
  if(fmt==='csv'){
    const csv = toCSV(rows, includeHeader);
    download(`export-${dataset}-${stamp}.csv`,'text/csv;charset=utf-8',csv);
  }else{
    const json = JSON.stringify(rows,null,2);
    download(`export-${dataset}-${stamp}.json`,'application/json',json);
  }
};

/* =================== Chatbox (i18n + theme sync) =================== */
const chatToggle=document.getElementById('chatToggle');
const chatbox=document.getElementById('chatbox');
const chatBody=document.getElementById('chatBody');
const chatInput=document.getElementById('chatInput');
const sendBtn=document.getElementById('sendBtn');
let greeted=false;

function addMsg(text, who='bot'){
  const wrap=document.createElement('div'); wrap.className='msg '+who;
  const av=document.createElement('div'); av.className='avatar-s'; av.textContent=(who==='bot'?'üê∑':'üë§');
  const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
  if(who==='bot'){wrap.append(av,b);} else {wrap.append(b,av);}
  chatBody.appendChild(wrap); chatBody.scrollTop=chatBody.scrollHeight;
}
function greetText(){return t('chat.greet');}
function openChat(){ chatbox.classList.add('open'); chatbox.setAttribute('aria-hidden','false'); if(!greeted){ addMsg(greetText()); greeted=true; } setTimeout(()=>chatInput.focus(),100); }
function closeChat(){ chatbox.classList.remove('open'); chatbox.setAttribute('aria-hidden','true'); }
chatToggle.onclick=()=> chatbox.classList.contains('open') ? closeChat() : openChat();

function handleSend(){
  const txt=chatInput.value.trim(); if(!txt) return;
  addMsg(txt,'user'); chatInput.value='';
  const k=txt.toLowerCase();
  if(k.includes('csv')) addMsg(t('chat.csv'));
  else if(k.includes('json')) addMsg(t('chat.json'));
  else if(k.includes('l·ªçc')||k.includes('time')||k.includes('date')||k.includes('range')) addMsg(t('chat.range'));
  else addMsg(t('chat.ask'));
}
sendBtn.onclick=handleSend;
chatInput.onkeydown=e=>{ if(e.key==='Enter') handleSend(); };

/* =================== Kh·ªüi t·∫°o & ƒë·ªìng b·ªô c√†i ƒë·∫∑t =================== */
(function bootstrap(){
  setTheme(getTheme());               // √°p theme ƒë√£ l∆∞u ·ªü C√†i ƒë·∫∑t
  const curLang=getLang();            // √°p ng√¥n ng·ªØ ƒë√£ l∆∞u ·ªü C√†i ƒë·∫∑t
  document.documentElement.setAttribute('lang',curLang);
  translatePage();
})();
window.addEventListener('storage', (e)=>{
  if(e.key==='theme' && e.newValue){ setTheme(e.newValue); }
  if(e.key==='lang'  && e.newValue){ setLang(e.newValue); if(greeted){ addMsg(greetText()); } }
});
</script>
</body>
</html>
